---
title: "Multisystem inflammatory syndrome in children related to COVID-19: a systematic review"
subtitle: "Data analysis"
author: "Levi Hoste, Ruben Van Paemel*, Filomeen Haerynck"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M:%S')`"
output:
  html_document:
    code_folding: hide
    highlight: kate
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_float: yes
    df_print: paged
    code_download: true
    fig_caption: yes
---

# Introduction
In this RMarkdown file, the data-analysis for the manuscript "Multisystem inflammatory syndrome in children related to COVID-19: a systematic review" is described. The complete data-analysis can be reproduced from the data collection sheet (in .xls format), provided in the supplementary data. 

```{r setup, include=TRUE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(cache = FALSE, warning = FALSE, message = FALSE)
options(digits = 3)
library(tidyverse)
require(readxl)
require(httr)
require(reshape2)
require(broom)
require(RColorBrewer)
require(scales)
require(ggrepel)
require(gridExtra)
require(ggExtra)
library(ggbeeswarm)
require(ggpubr)
library(cowplot)
library(naniar)
require(DT)
require(zoo)
require(psych)
library(skimr)
library(UpSetR)
library(see)
library(wesanderson)

options(scipen=999)

co_hb <- 12
co_neutrophilia <- 8000
co_CRP <- 10
co_lympho <- 1250
co_fibrino <- 400
co_Ddim <- 250
co_ferritin <- 300
co_albu <- 34
co_PCT <- 0.49
co_LDH <- 280
co_IL6 <- 16.4
co_ESR <- 22
co_BNP <- 100
co_NTproBNP <- 400
co_tropo <- 40
co_WBC <- 11000
co_platelet <- 150000
co_sodium <- 135
#input = df_cohort_controls
#find = "max"
#param = "CRP"

collapse_labvals_cohort <- function(input, find, param){
  if (find == "max"){
    df <- input %>% select(contains(param) | contains("cohort_id") | contains("cohort_type") | contains("tot_cases_n"))
    print("Column extracted from cohorts:")
    print(colnames(df))
    df_med <- df %>% select(contains("med"))
    df_med <- type_convert(df_med)
    df_med <- df_med %>% mutate_all(funs(replace_na(., -999)))
   # colnames(df_med)[max.col(df_med,ties.method="first")]
    df_med <- df_med %>% mutate(med = as.numeric(apply(df_med, 1, max)))
    
    df_min <- df %>% select(contains("Q1"))
    df_min <- type_convert(df_min)
    df_min <- df_min %>% mutate_all(funs(replace_na(., 0)))
    #colnames(df_min)[max.col(df_min,ties.method="first")]
    df_min <- df_min %>% mutate(min = as.numeric(apply(df_min, 1, max)))
    
    df_max <- df %>% select(contains("Q3"))
    df_max <- type_convert(df_max)
    df_max <- df_max %>% mutate_all(funs(replace_na(., 0)))
    #colnames(df_max)[max.col(df_max,ties.method="first")]
    df_max <- df_max %>% mutate(max = as.numeric(apply(df_max, 1, max)))
    
    df_full <- cbind(df %>% select(cohort_id, cohort_type, tot_cases_n), df_med %>% select(med), df_min %>% select(min), df_max %>% select(max))
    df_full[df_full == -999] <- NA
    names(df_full)[names(df_full) == 'max'] <- paste0(param, "_max")
    names(df_full)[names(df_full) == 'min'] <- paste0(param, "_min")
    names(df_full)[names(df_full) == 'med'] <- paste0(param, "_med")
    df_full$data_descr <- "IQR"
    df_full$cohort_id <- paste0(df_full$cohort_id, " (n = ", as.character(df_full$tot_cases_n),")")
    write.csv(df_full, paste0("./data/cohort_", param, ".csv"))
    print(datatable(df_full, caption = paste0("overview of ", param)))
    return(df_full)
  }
    else if (find == "min"){
    df <- input %>% select(contains(param) | contains("cohort_id") | contains("cohort_type") | contains("tot_cases_n"))
    print("Column extracted from cohorts:")
    print(colnames(df))
    df_med <- df %>% select(contains("med"))
    df_med <- type_convert(df_med)
    df_med <- df_med %>% mutate_all(funs(replace_na(., 1e6)))
   # colnames(df_med)[max.col(df_med,ties.method="first")]
    df_med <- df_med %>% mutate(med = as.numeric(apply(df_med, 1, min)))
    
    df_min <- df %>% select(contains("Q1"))
    df_min <- type_convert(df_min)
    df_min <- df_min %>% mutate_all(funs(replace_na(., 1e6)))
    #colnames(df_min)[max.col(df_min,ties.method="first")]
    df_min <- df_min %>% mutate(min = as.numeric(apply(df_min, 1, min)))
    
    df_max <- df %>% select(contains("Q3"))
    df_max <- type_convert(df_max)
    df_max <- df_max %>% mutate_all(funs(replace_na(., 1e6)))
    #colnames(df_max)[max.col(df_max,ties.method="first")]
    df_max <- df_max %>% mutate(max = as.numeric(apply(df_max, 1, min)))
    
    df_full <- cbind(df %>% select(cohort_id, cohort_type, tot_cases_n), df_med %>% select(med), df_min %>% select(min), df_max %>% select(max))
    df_full[df_full == 1e6] <- NA
    names(df_full)[names(df_full) == 'max'] <- paste0(param, "_max")
    names(df_full)[names(df_full) == 'min'] <- paste0(param, "_min")
    names(df_full)[names(df_full) == 'med'] <- paste0(param, "_med")
    df_full$data_descr <- "IQR"
    df_full$cohort_id <- paste0(df_full$cohort_id, " (n = ", as.character(df_full$tot_cases_n),")")
    write.csv(df_full, paste0("./data/cohort_", param, ".csv"))
    print(datatable(df_full, caption = paste0("overview of ", param)))
    return(df_full)
  }
}

#input = df_singlecases
#find = "max"
#param = "CRP"

collapse_labvals_single <- function(input, find, param){
  if (find == "max"){
    df <- input %>% select(contains(param) | contains("cohort_id"))
    print("Column extracted from single cases:")
    print(colnames(df))
    df_coll <- df %>% mutate_all(funs(replace_na(., -999)))
    df_coll <- type_convert(df_coll)
   # colnames(df_med)[max.col(df_med,ties.method="first")]
    df_coll <- df_coll %>% mutate(max = as.numeric(apply(df_coll, 1, max)))
    
    df_coll[df_coll == -999] <- NA
    names(df_coll)[names(df_coll) == 'max'] <- paste0(param, "_max")
    df_coll$data_descr <- "IQR"
    df_coll$cohort_id <- paste0("single cases (n = ", as.character(n_single_cases),")")
    write.csv(skim(df_coll), paste0("./data/singlecases_", param, ".csv"))
    return(df_coll)
  }
    else if (find == "min"){
    df <- input %>% select(contains(param) | contains("cohort_id"))
    print("Column extracted from single cases:")
    print(colnames(df))
    df_coll <- df %>% mutate_all(funs(replace_na(., 1e6)))
   # colnames(df_med)[max.col(df_med,ties.method="first")]
    df_coll <- df_coll %>% mutate(min = as.numeric(apply(df_coll, 1, min)))
    
    df_coll[df_coll == 1e6] <- NA
    names(df_coll)[names(df_coll) == 'min'] <- paste0(param, "_min")
    df_coll$cohort_id <- paste0("single cases (n = ", as.character(n_single_cases),")")
    write.csv(skim(df_coll), paste0("./data/singlecases_", param, ".csv"))
    return(df_coll)
  }
}


moveme <- function (df, movecommand) {
  invec <- names(df)
  
  movecommand <- lapply(strsplit(strsplit(movecommand, ";")[[1]], 
                                 ",|\\s+"), function(x) x[x != ""])
  movelist <- lapply(movecommand, function(x) {
    Where <- x[which(x %in% c("before", "after", "first", 
                              "last")):length(x)]
    ToMove <- setdiff(x, Where)
    list(ToMove, Where)
  })
  myVec <- invec
  for (i in seq_along(movelist)) {
    temp <- setdiff(myVec, movelist[[i]][[1]])
    A <- movelist[[i]][[2]][1]
    if (A %in% c("before", "after")) {
      ba <- movelist[[i]][[2]][2]
      if (A == "before") {
        after <- match(ba, temp) - 1
      }
      else if (A == "after") {
        after <- match(ba, temp)
      }
    }
    else if (A == "first") {
      after <- 0
    }
    else if (A == "last") {
      after <- length(myVec)
    }
    myVec <- append(temp, values = movelist[[i]][[1]], after = after)
  }
  
  df[,match(myVec, names(df))]
}

makeBarplot <- function(var_id_cohort, var_id_single, var_id){

        n_cohort <- df_cohort %>% select(tot_cases_n) %>% sum()#, outcome_death_n)
        var_cohort <- df_cohort[var_id_cohort] %>% sum(., na.rm = TRUE)#, outcome_death_n)
        
        n_single <- df_singlecases %>% nrow()
        
        var_single <- df_singlecases %>% filter(get(var_id_single) == TRUE) %>% nrow()
        
        n_all <- n_cohort + n_single
        var_all <- var_cohort + var_single
        
        bar_df_abs <- data.frame(x = c("cohort", "cohort", "single cases", "single cases", "all", "all"), col = c("total", var_id, "total", var_id, "total", var_id), vals = c(n_cohort, var_cohort, n_single, var_single, n_all, var_all) )
        
        bar_df_prct <- data.frame(x = c("cohort", "cohort", "single cases", "single cases", "all", "all"), col = c(paste0(var_id, " -"), paste0(var_id, " +"), paste0(var_id, " -"), paste0(var_id, " +"), paste0(var_id, " -"), paste0(var_id, " +")), vals = c(100-(var_cohort/n_cohort*100), var_cohort/n_cohort*100, 100-(var_single/n_single*100), var_single/n_single*100, 100-(var_all/n_all*100), var_all/n_all*100) )

        
        p_abs <- ggplot(bar_df_abs, aes(x = x, y =  vals, fill = col)) +
            geom_bar(stat = "identity", position = "dodge") +
            theme_bw() + 
            labs(title = paste0("Total cases vs ", var_id), subtitle = "Absolute numbers", x = "group", y = "n", col = "") +
  scale_fill_manual(values = wes_palette("Royal1"))
        
        
        p_prct <- ggplot(bar_df_prct, aes(x = x, y =  vals, fill = col)) +
            geom_bar(stat = "identity", position = "fill") +
            theme_bw() + 
            labs(title = paste0(var_id), subtitle = "Percent", x = "group", y = "%", col = "")  +
    scale_y_continuous(labels = scales::percent)+
  scale_fill_manual(values = wes_palette("Royal1"))
        
        ggarrange(p_abs, p_prct, legend = "bottom")
  
}

makeHeatmap_cohort <- function(param1, colname_single, exclude_single = NULL, plottitle, textsize = 3){
  var_cohort <- df_cohort %>% select(("cohort_id") | "tot_cases_n" | ( contains(param1) & contains("_n")))
  var_cohort$cohort_id <- paste0(var_cohort$cohort_id, " (n = ", as.character(var_cohort$tot_cases_n),")")
  var_cohort <- var_cohort %>% 
    gather(variable, value, 3:ncol(var_cohort)) %>% group_by(cohort_id, variable) %>% summarize(prct = value/tot_cases_n*100)
  var_cohort$variable <- sub("_n", "", var_cohort$variable)

if (!is.null(exclude_single)){
  var_single <- df_singlecases %>% select(-contains(exclude_single))
  var_single <- var_single %>% select(contains(colname_single))
} else
{
  var_single <- df_singlecases %>% select(contains(colname_single))
}

 #%>% select(-contains("any"))
cols <- sapply(var_single, is.logical)
var_single[,cols] <- lapply(var_single[,cols], as.numeric)
var_single <- colSums(var_single, na.rm = TRUE)
var_single <- var_single/nrow(df_singlecases)*100
var_single <- as.data.frame(var_single) %>% rownames_to_column()
var_single$cohort_id <- "single_cases"
colnames(var_single) <- c("variable", "prct", "cohort_id")


missing <- setdiff(var_single$variable, var_cohort$variable)
if (length(missing) != 0 ){
  missing_df <- data.frame(variable = missing, prct = NA, cohort_id = unique(var_cohort$cohort_id))
  var_cohort <- bind_rows(var_cohort, as_tibble(missing_df))
} else if (length(missing) == 0) {
  missing <- setdiff(var_cohort$variable, var_single$variable)
  if (length(missing) != 0){
  missing_df <- data.frame(variable = missing, prct = NA, cohort_id = unique(var_single$cohort_id))
  var_single <- bind_rows(var_single, as_tibble(missing_df))
  }
}

hm_cohort <- ggplot(var_cohort, aes(x = variable, y = cohort_id, fill = prct)) + 
    geom_tile() + theme_classic() +
    theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.line=element_blank())+
   scale_fill_gradient(low = "yellow", high="red", na.value = "lightgray", limits = c(0,100)) +
    labs(x = "", y = "cohort", title =plottitle) +
    geom_text(aes(label=round(prct, 2)), size = textsize, color = "black")

hm_single <- ggplot(var_single, aes(x = variable, y = cohort_id, fill = prct)) + 
    geom_tile() +  theme_classic() +
    theme(axis.text.x=element_text(angle=90, hjust=1), axis.line=element_blank())+
    scale_fill_gradient(low = "yellow", high = "red", na.value = "lightgray", limits = c(0,100))+ labs(y = "cohort") +
    geom_text(aes(label=round(prct, 2)), size = textsize, color = "black") 

plot_grid(hm_cohort, hm_single, align = "v", nrow = 2, rel_heights = c(1/2, 1/2))
}
```


# Data import and cleaning
## Single cases
First, we import the single cases from the general excel sheet and transform the excel sheet so that variables are columns and rows are cases. Columns without any values are also removed. 

The single cases from Pouletty (10.1136/annrheumdis-2020-217960) are excluded (as they are included in the cohorts).


```{r}
df_singlecases <-
  read_excel("/Users/rmvpaeme/Onedrive/UGent/PIMS-TS Systematic Review - Data extractie/data extractie.xlsx",
             sheet = "Single cases",
             skip = 1,
             col_names = FALSE)[,-c(1:2)]
df_singlecases <- df_singlecases %>% t()
df_singlecases <- as.data.frame(df_singlecases, stringsAsFactors = FALSE)
nms <- as.vector(df_singlecases[1,])
nms[is.na(nms)] <- 'tmp'
colnames(df_singlecases) <- make.unique(as.character(nms))
df_singlecases <- df_singlecases[-1,]
df_singlecases <- df_singlecases %>% select(-contains("tmp"))
df_singlecases <- df_singlecases %>% select(-variable_id)

df_singlecases <- df_singlecases %>% 
  mutate_all(funs(str_replace(., "Yes", "yes")))
df_singlecases <- df_singlecases %>% 
  mutate_all(funs(str_replace(., "No", "no")))
df_singlecases <- df_singlecases %>% 
  mutate_all(funs(str_replace(., "pos", "yes")))
df_singlecases <- df_singlecases %>% 
  mutate_all(funs(str_replace(., "neg", "no")))

df_singlecases <- df_singlecases %>%
  replace_with_na_all(condition = ~.x == "NA")

df_singlecases <- type_convert(df_singlecases)
df_singlecases_inclPouletty <- df_singlecases
df_singlecases <- df_singlecases %>% filter(doi != "https://10.1136/annrheumdis-2020-217960")  # these cases are excluded according to the data sheet

df_singlecases <- df_singlecases[colSums(!is.na(df_singlecases)) > 0]
n_single_cases <- nrow(df_singlecases)
```

### Making summary statistics

In this section, data is summarized. For example, if there are any comorbidities present, a column "comorb_any" is added and annotated as TRUE. The same is done for COVID serology and symptoms of major organ (respiratory, cardiovascular etc).

```{r}
df_singlecases <- df_singlecases %>% mutate(comorb_any = apply(df_singlecases %>% select(contains("comorb")), 1, any))
df_singlecases <- df_singlecases %>% moveme(., "comorb_any before comorb_cardiovasc")
```

If IgG, IgA, IgM or COVID serology is reported as positive, the column covid_sero_any is annotated as TRUE.

```{r}
df_singlecases <- df_singlecases %>% mutate(covid_sero_any = apply(df_singlecases %>% select(covid_sero_pos, covid_IgA_pos, covid_IgM_pos, covid_IgG_pos), 1, any))

df_singlecases <- df_singlecases %>% moveme(., "covid_sero_any before covid_sero_pos")
```

If PCR+, stool PCR+, IgG, IgA, IgM or COVID serology is reported as positive, the column covid_pos_any is annotated as TRUE.

```{r}
df_singlecases <- df_singlecases %>% mutate(covid_pos_any = apply(df_singlecases %>% select(covid_PCR_pos, covid_PCR_stool_pos, covid_sero_pos, covid_IgA_pos, covid_IgM_pos, covid_IgG_pos), 1, any))

df_singlecases <- df_singlecases %>% moveme(., "covid_pos_any before covid_sero_any")
```

If any respiratory symptoms, symp_resp_any is annotated as TRUE.

```{r}
df_singlecases <- df_singlecases %>% mutate(symp_resp_any = apply(df_singlecases %>% select(symp_resp_NS, symp_resp_URT, symp_resp_dyspnea, symp_resp_pneumonia, symp_resp_failure, symp_resp_chestpain), 1, any))

df_singlecases <- df_singlecases %>% moveme(., "symp_resp_any before symp_resp_NS")
```

If any GI symptoms, symp_GI_any is annotated as TRUE.

```{r}
df_singlecases <- df_singlecases %>% mutate(symp_GI_any = apply(df_singlecases %>% select(contains("symp_GI")), 1, any))

df_singlecases <- df_singlecases %>% moveme(., "symp_GI_any before symp_GI_NS")
```

If any neurological symptoms, symp_neuro_any is annotated as TRUE.

```{r}
df_singlecases <- df_singlecases %>% mutate(symp_neuro_any = apply(df_singlecases %>% select(symp_neuro_headache,symp_neuro_meningitis,symp_neuro_meningism,symp_neuro_asthenia,symp_neuro_irritab), 1, any))

df_singlecases <- df_singlecases %>% moveme(., "symp_neuro_any before symp_neuro_GCS")
```

If any renal symptoms, symp_renal_any is annotated as TRUE.

```{r}
df_singlecases <- df_singlecases %>% mutate(symp_renal_any = apply(df_singlecases %>% select(symp_renal_AKI), 1, any))

df_singlecases <- df_singlecases %>% moveme(., "symp_renal_any before symp_renal_AKI")
```

If any cardiovascular symptoms, symp_cardiovasc_any is annotated as TRUE.

```{r}
df_singlecases <- df_singlecases %>% mutate(symp_cardiovasc_any = apply(df_singlecases %>% select(symp_cardiovasc_myocard,
symp_cardiovasc_pericard,
symp_cardiovasc_cordilat,
symp_cardiovasc_aneurysm,
symp_cardiovasc_shock,
symp_cardiovasc_tachycard,
symp_cardiovasc_arrhyt), 1, any))

df_singlecases <- df_singlecases %>% moveme(., "symp_cardiovasc_any before symp_cardiovasc_myocard")

write.csv(df_singlecases, paste0("./data/df_singlecases.csv"))

datatable(df_singlecases, caption = "Single cases dataframe")

```

## Cohorts
Afterwards, we do the same for the cohort sheet.

The papers by Grimaud et al. and Verdoni et al. are removed from the cohort dataframe, as most information is present in the single cases dataframe. 
```{r}
df_cohort <-
  read_excel("/Users/rmvpaeme/Onedrive/UGent/PIMS-TS Systematic Review - Data extractie/data extractie.xlsx",
             sheet = "Cohorts",
             skip = 1,
             col_names = FALSE)[,-c(1:3)]


df_cohort <- df_cohort %>% t()
df_cohort <- as.data.frame(df_cohort, stringsAsFactors = FALSE)
nms <- as.vector(df_cohort[1,])
nms[is.na(nms)] <- 'tmp'
colnames(df_cohort) <- make.unique(as.character(nms))
df_cohort <- df_cohort[-1,]
df_cohort <- df_cohort %>% select(-contains("tmp"))
df_cohort <- df_cohort %>% select(-variable_id)

df_cohort <- df_cohort %>% 
  mutate_all(funs(str_replace(., "Yes", "yes")))
df_cohort <- df_cohort %>% 
  mutate_all(funs(str_replace(., "No", "no")))
df_cohort <- df_cohort %>% 
  mutate_all(funs(str_replace(., "pos", "yes")))
df_cohort <- df_cohort %>% 
  mutate_all(funs(str_replace(., "neg", "no")))

df_cohort <- df_cohort %>%
  replace_with_na_all(condition = ~.x == "NA")

df_cohort <- type_convert(df_cohort)

df_cohort <- df_cohort[colSums(!is.na(df_cohort)) > 0]

df_cohort <- df_cohort %>% filter(doi != "https://doi.org/10.1186/s13613-020-00690-8") %>% filter(doi != "https://doi.org/10.1016/S0140-6736(20)31103-X")

df_cohort_controls <- df_cohort

df_cohort <- df_cohort %>% filter(cohort_type == "covid")

write.csv(df_cohort, paste0("./data/df_cohort.csv"))

datatable(df_cohort, caption = "Cohort dataframe")
```



# Descriptive statistics {.tabset}
## General


**Click on the any of the tabs above to see descriptive statistics for every variable**      



## Single cases
**How to read**  
Under "Variable type: logical", the number of true/falses are depicted. E.g. at the top we can see that there are 95 number of rows (= 95 patients). Overweight has 79 missing values (17% is complete), which means that 95-79=16 patients have either "TRUE" or "FALSE" for overweight. Of these 16, 9 are marked as "TRUE" for overweight. 

 <a href="#top">Download data as .csv on Github</a>

```{r}
skim(df_singlecases)
write.csv(skim(df_singlecases), paste0("./data/singlecases_descriptivestats.csv"))
```

## Cohorts
**How to read**  
The sum column equals the sum of all individuals, e.g. sum(tot_cases_n) means that there are 592 patients in total in the cohorts; sum(outcome_death_n) means that 9 patients died. 

The "Prct_total" column is the percentage of e.g. death (9/592). Only makes sense where n is reported e.g. therapy (not for lab values).

```{r}
skimsum <- skim_with(numeric = sfl(sum = ~ sum(., na.rm = TRUE), Prct_total = ~ sum(., na.rm = TRUE)/sum(df_cohort$tot_cases_n)*100), append = TRUE)
skimsum(df_cohort)
write.csv(skimsum(df_cohort), paste0("./data/cohort_descriptivestats.csv"))
```

## Historical controls
```{r}
df_cohort_controls_stats <- df_cohort_controls %>% filter(cohort_type == "control")
df_cohort_controls_stats <- df_cohort_controls_stats[colSums(!is.na(df_cohort_controls_stats)) > 0]
skimsum <- skim_with(numeric = sfl(sum = ~ sum(., na.rm = TRUE), Prct_total = ~ sum(., na.rm = TRUE)/sum(df_cohort_controls_stats$tot_cases_n)*100), append = TRUE)
skimsum(df_cohort_controls_stats)

write.csv(skimsum(df_cohort_controls_stats), paste0("./data/historicalcontrols_descriptivestats.csv"))

write.csv(df_cohort_controls_stats, paste0("./data/df_cohort_controls_stats.csv"))
```


# Data exploration
## Total cases and deaths
```{r}
#var_id_cohort = "outcome_death_n"
#var_id_single = "outcome_death"
#var_id = "deaths"
makeBarplot("outcome_death_n", "outcome_death", "deaths")
```

## Sex
```{r}
n_cohort <- df_cohort %>% select(tot_cases_n) %>% sum()
var_cohort <- df_cohort %>% select(contains("sex"))
var_cohort <- colSums(var_cohort, na.rm = TRUE)
var_cohort <- var_cohort/sum(df_cohort$tot_cases_n)*100
var_cohort["sex_na"] <- (100 - var_cohort["sex_m"] - var_cohort["sex_f"])

var_control <- df_cohort_controls %>% filter(cohort_id == "Pouletty - control") %>% select(contains("sex"))
var_control <- colSums(var_control, na.rm = TRUE)
var_control <- var_control/sum(df_cohort_controls %>% filter(cohort_id == "Pouletty - control") %>% select(tot_cases_n))*100
var_control["sex_na"] <- (100 - var_control["sex_m"] - var_control["sex_f"])

n_single <- df_singlecases %>% nrow()
var_single <- df_singlecases %>% select(contains("sex"))
var_single$sex_m <- ifelse(var_single$sex == "M", TRUE, FALSE)
var_single$sex_f <- ifelse(var_single$sex == "F", TRUE, FALSE)
cols <- sapply(var_single, is.logical)
var_single[,cols] <- lapply(var_single[,cols], as.numeric)
var_single <- colSums(var_single %>% select(-sex), na.rm = TRUE)
var_single <- var_single/nrow(df_singlecases)*100
var_single["sex_na"] <- (100 - var_single["sex_m"] - var_single["sex_f"])

bar_df_prct <- data.frame(
  x = c("males", "females", "missing", "males", "females", "missing", "males", "females", "missing"),
  vals = c(var_single, var_cohort, var_control),
  col = c(rep("single", length(var_single)), rep("cohorts", length(var_cohort)), rep("histor ctrl", length(var_control))
))

p_prct <- ggplot(bar_df_prct, aes(x = col, y =  vals, fill = x)) +
    geom_bar(stat = "identity", position = "stack") +
    theme_bw() + 
    labs(title = "Male/female distribution in dataset", subtitle = "Prct", x = "sex", y = "%", col = " ")  + lims(y = c(0,100)) + theme(axis.text.x=element_text(angle=90, hjust=1))+
  scale_fill_manual(values = wes_palette("Royal1"))
p_prct
```


```{r}
var_cohort <- df_cohort %>% select(contains("sex") | ("cohort_id") | "tot_cases_n")
sex_f <- var_cohort %>% group_by(cohort_id) %>% summarize(prct = sex_f/tot_cases_n) %>%  mutate(sex = "female")
sex_m <- var_cohort %>% group_by(cohort_id) %>% summarize(prct = sex_m/tot_cases_n) %>% mutate(sex = "male")
sex_all <- rbind(sex_f, sex_m)

p_sex_cohort <- ggplot(sex_all, aes(y = cohort_id, x = prct, fill = sex)) + 
          geom_bar(stat = "identity", position = "fill") + 
          theme_bw() + labs(x = "") + 
          scale_fill_manual(values = wes_palette("Royal1"))

var_controls <- df_cohort_controls %>% filter(cohort_id == "Pouletty - control") %>% select(contains("sex") | ("cohort_id") | "tot_cases_n")
sex_f <- var_controls %>% group_by(cohort_id) %>% summarize(prct = sex_f/tot_cases_n) %>% mutate(sex = "female")
sex_m <- var_controls %>% group_by(cohort_id) %>% summarize(prct = sex_m/tot_cases_n) %>% mutate(sex = "male")
sex_all <- rbind(sex_f, sex_m)

p_sex_controls <- ggplot(sex_all, aes(y = cohort_id, x = prct, fill = sex)) + 
          geom_bar(stat = "identity", position = "fill") + 
          theme_bw() + labs(x = "") + 
          scale_fill_manual(values = wes_palette("Royal1"))

n_single <- df_singlecases %>% nrow()
var_single <- df_singlecases %>% select(contains("sex"))
var_single$sex_m <- ifelse(var_single$sex == "M", TRUE, FALSE)
var_single$sex_f <- ifelse(var_single$sex == "F", TRUE, FALSE)
cols <- sapply(var_single, is.logical)
var_single[,cols] <- lapply(var_single[,cols], as.numeric)
var_single <- colSums(var_single %>% select(-sex), na.rm = TRUE)
var_single <- var_single/nrow(df_singlecases)*100

sex_single <- data.frame(cohort_id = "single_cases", prct = c(var_single["sex_m"], var_single["sex_f"]), sex = c("male", "female"))

p_sex_single <- ggplot(sex_single, aes(y = cohort_id, x = prct, fill = sex)) + 
          geom_bar(stat = "identity", position = "fill") + 
          theme_bw() + 
          scale_fill_manual(values = wes_palette("Royal1"))

a <- plot_grid(p_sex_cohort, p_sex_controls, p_sex_single, align = "v", nrow = 3, rel_heights = c(5/7, 1/7, 1/7))
a
```

## Age distribution

```{r}
cohort_age <- df_cohort_controls %>% select(contains("cohort_id") | contains("age") | contains("cohort_type")  | contains("tot_cases_n"))
cohort_age$cohort_id <- paste0(cohort_age$cohort_id, " (n = ", cohort_age$tot_cases_n,")")
cohort_age$age_med_yrs <- as.numeric(cohort_age$age_med_yrs )
cohort_age$age_Q1_yrs <- as.numeric(cohort_age$age_Q1_yrs)
cohort_age$age_Q3_yrs <- as.numeric(cohort_age$age_Q3_yrs)
cohort_age$age_min_yrs <- as.numeric(cohort_age$age_min_yrs)
cohort_age$age_max_yrs <- as.numeric(cohort_age$age_max_yrs)

cohort_age$data_descr <- ifelse(!is.na(cohort_age$age_Q1_yrs) & is.na(cohort_age$age_min_yrs) , "IQR", 
                                ifelse(is.na(cohort_age$age_Q1_yrs) & !is.na(cohort_age$age_min_yrs), "range", 
                                    ifelse(!is.na(cohort_age$age_Q1_yrs) & !is.na(cohort_age$age_min_yrs), "both", "none")))

p_age_cohort <- ggplot(cohort_age %>% filter(cohort_type == "covid"), aes(y = cohort_id, x = age_med_yrs, col = data_descr)) + 
        geom_point(size = 4) + 
        geom_errorbar(aes(xmin=age_Q1_yrs, xmax=age_Q3_yrs), width=.8, position=position_dodge(.9)) +
        geom_errorbar(aes(xmin=age_min_yrs,  xmax=age_max_yrs), width=.2, position=position_dodge(.9)) +
        theme_bw() + lims(x = c(0,21)) + 
        labs(y = "cohort", x = "", col = "bars") + theme(legend.position="top")+
        scale_color_manual(values = c(wes_palette("BottleRocket2")[1:3], wes_palette("BottleRocket1")[2]))

p_age_controls <- ggplot(cohort_age %>% filter(cohort_type != "covid"), aes(y = cohort_id, x = age_med_yrs, col = data_descr)) + 
        geom_point(size = 4) + 
        geom_errorbar(aes(xmin=age_Q1_yrs, xmax=age_Q3_yrs), width=.2, position=position_dodge(.9)) +
        geom_errorbar(aes(xmin=age_min_yrs,  xmax=age_max_yrs), width=.2, position=position_dodge(.9)) +
        theme_bw() + lims(x = c(0,21)) +
        labs(y = "cohort", x = "", col = "bars") + theme(legend.position="none")+
        scale_color_manual(values = wes_palette("BottleRocket2")[2])

p_age_single <- ggplot(df_singlecases, aes(x = as.numeric(age), y = paste0("single cases (n = ", n_single,")"))) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + lims(x = c(0,21)) + 
      labs(y = "cohort", x = "Age (years)")

a <- plot_grid(p_age_cohort, p_age_controls, p_age_single, align = "v", nrow = 3, rel_heights = c(2/3, 1/5, 1/3))
a
```


## Symptoms 
### Single cases {.tabset}
#### All symptoms
```{r}
makeUpsetR <- function(input_df){
var_single <- input_df 
cols <- sapply(var_single, is.logical)
var_single[,cols] <- lapply(var_single[,cols], as.numeric)

var_single_upsetr <- var_single 
var_single_upsetr[is.na(var_single_upsetr)] <- 0
var_single_upsetr <- as.data.frame(var_single_upsetr)
for(i in 1:ncol(var_single_upsetr)){ var_single_upsetr[ , i] <- as.integer(var_single_upsetr[ , i]) }
upset(var_single_upsetr, sets = c(colnames(var_single_upsetr)), sets.bar.color = "#56B4E9",
order.by = "freq", keep.order = TRUE)#, empty.intersections = "on", keep.order = FALSE)
}

makeUpsetR(df_singlecases %>% select(contains( "symp")) %>% select(contains("any")))
```

#### Respiratory
```{r}
makeUpsetR(df_singlecases %>% select(contains("symp")) %>% select(contains("resp")) %>% select(-contains("any")))
```

#### Cardiovascular
```{r}
makeUpsetR(df_singlecases %>% select(contains("symp")) %>% select(contains("cardiovasc")) %>% select(-contains("LVEF")) %>% select(-contains("any")))
```

#### GI
```{r}
makeUpsetR(df_singlecases %>% select(contains("symp")) %>% select(contains("GI")) %>% select(-contains("neuro")) %>% select(-contains("any")))
```

### Single cases + cohort {.tabset}
#### Respiratory
```{r}
barSymp <- function(colname_chort, colname_single, exclude_single = NULL, plottitle){

var_cohort <- df_cohort %>% 
                        select(contains("cohort_id") | contains("tot_cases_n") | (contains(colname_chort) & contains("_n")))

var_cohort <- var_cohort %>% 
        gather(variable, value, 3:ncol(var_cohort)) %>% 
        drop_na(value)  %>% group_by(variable) %>% 
        summarize(prct = sum(value)/sum(tot_cases_n)*100)

var_cohort <- setNames(var_cohort$prct, var_cohort$variable)
names(var_cohort) <- sub("_n", "", names(var_cohort))

n_single <- df_singlecases %>% nrow()

if (!is.null(exclude_single)){
  var_single <- df_singlecases %>% select(-contains(exclude_single))
  var_single <- var_single %>% select(contains(colname_single))
} else
{
  var_single <- df_singlecases %>% select(contains(colname_single))
}

 #%>% select(-contains("any"))
cols <- sapply(var_single, is.logical)
var_single[,cols] <- lapply(var_single[,cols], as.numeric)
var_single <- colSums(var_single, na.rm = TRUE)
var_single <- var_single/nrow(df_singlecases)*100

bar_df_prct <- data.frame(
  x = c(names(var_single), names(var_cohort)),
  vals = c(var_single, var_cohort),
  col = c(rep("single", length(var_single)), rep("cohorts", length(var_cohort)))
)

p_prct <- ggplot(bar_df_prct, aes(x = x, y =  vals, fill = col)) +
    geom_bar(stat = "identity", position = "dodge") +
    theme_bw() + 
    labs(title = plottitle, 
          subtitle = "Percent of group", x = "treatment", y = "%", col = " ")  + 
          theme(axis.text.x=element_text(angle=90, hjust=1))+
          scale_fill_manual(values = wes_palette("Royal1"))
p_prct
}

makeHeatmap_cohort("symp_resp", "symp_resp", plottitle = "Cases with respiratory symptoms, per cohort")

barSymp("symp_resp", "symp_resp", plottitle = "Cases with respiratory symptoms")
```


```{r}
# var_cohort <- df_cohort %>% select(("cohort_id") | "tot_cases_n" |( contains("symp_resp") & contains("n")))
# 
# resp_symp_cohort <- var_cohort %>% 
#   gather(variable, value, 3:ncol(var_cohort)) %>% group_by(cohort_id, variable) %>% summarize(prct = value/tot_cases_n)
# 
# ggplot(resp_symp_cohort, aes(x = prct, y = cohort_id, col = variable)) + geom_point()
```

#### Cardiovascular
```{r}
makeHeatmap_cohort("symp_cardiovasc", "symp_cardiovasc", exclude_single = "symp_cardiovasc_LVEF", plottitle = "Cases with cardiovascular symptoms, per cohort")

barSymp("symp_cardiovasc", "symp_cardiovasc", exclude_single = "symp_cardiovasc_LVEF", plottitle = "Cases with cardiovascular symptoms")
```

#### Gastro-intestinal
```{r}
makeHeatmap_cohort("symp_GI", "symp_GI", plottitle = "Cases with GI symptoms, per cohort")

barSymp("symp_GI", "symp_GI", plottitle = "Cases with GI symptoms")
```

## COVID contact
```{r}
var_cohort <- df_cohort %>% select(("cohort_id" | "tot_cases_n") | ( contains("covid") & contains("_n") & (contains("pos") | contains("closecont")  | contains("any"))))
var_cohort$cohort_id <- paste0(var_cohort$cohort_id, " (n = ", as.character(var_cohort$tot_cases_n),")")

var_cohort <- var_cohort %>% 
  gather(variable, value, 3:ncol(var_cohort)) %>% group_by(cohort_id, variable) %>% summarize(prct = value/tot_cases_n*100)

var_cohort$variable <- sub("n_", "", var_cohort$variable)

var_single <- df_singlecases %>% select(contains("covid"))
cols <- sapply(var_single, is.logical)
var_single[,cols] <- lapply(var_single[,cols], as.numeric)
var_single <- colSums(var_single, na.rm = TRUE)
var_single <- var_single/nrow(df_singlecases)*100
var_single <- as.data.frame(var_single) %>% rownames_to_column()
var_single$cohort_id <- "single_cases"
colnames(var_single) <- c("variable", "prct", "cohort_id")


missing <- setdiff(var_single$variable, var_cohort$variable)
if (length(missing) != 0 ){
  missing_df <- data.frame(variable = missing, prct = rep(NA, length(missing)), cohort_id = rep(unique(var_cohort$cohort_id), length(missing)))
  var_cohort <- bind_rows(var_cohort, as_tibble(missing_df))
} 

missing <- setdiff(var_cohort$variable, var_single$variable)

if (length(missing) != 0) {
  if (length(missing) != 0){
data.frame(variable = missing, prct = rep(NA, length(missing)), cohort_id = rep(unique(var_single$cohort_id), length(missing)))
  var_single <- bind_rows(var_single, as_tibble(missing_df))
  }
}


hm_cohort <- ggplot(var_cohort, aes(x = variable, y = cohort_id, fill = prct)) + 
    geom_tile() + theme_classic() +
    theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.line=element_blank())+
   scale_fill_gradient(low = "yellow", high="red", na.value = "lightgray", limits = c(0,100)) +
    labs(x = "", y = "cohort", title = "COVID symptoms, per cohort") +
    geom_text(aes(label=round(prct, 2)), size = 3, color = "black")

hm_single <- ggplot(var_single, aes(x = variable, y = cohort_id, fill = prct)) + 
    geom_tile() +  theme_classic() +
    theme(axis.text.x=element_text(angle=90, hjust=1), axis.line=element_blank())+
    scale_fill_gradient(low = "yellow", high = "red", na.value = "lightgray", limits = c(0,100))+ labs(y = "cohort") +
    geom_text(aes(label=round(prct, 2)), size = 3, color = "black") 

plot_grid(hm_cohort, hm_single, align = "v", nrow = 2, rel_heights = c(1/2, 1/2))

```

```{r}
var_cohort <- df_cohort %>% 
                        select(contains("cohort_id") | contains("tot_cases_n") | contains("covid") & contains("_n") & (contains("_pos") | contains("close")))

covid_cohort <- var_cohort %>% 
        gather(variable, value, 3:ncol(var_cohort)) %>% 
        drop_na(value)  %>% group_by(variable) %>% 
        summarize(prct = sum(value)/sum(tot_cases_n)*100)

covid_cohort <- setNames(covid_cohort$prct, covid_cohort$variable)

n_single <- df_singlecases %>% nrow()
var_single <- df_singlecases %>% select(contains("covid")) 
cols <- sapply(var_single, is.logical)
var_single[,cols] <- lapply(var_single[,cols], as.numeric)

makeUpsetR(df_singlecases %>% select(contains("covid")) %>% select(-contains("covid_IgM_pos")) %>% select(-contains("covid_IgA_pos"))  %>% select(-contains("covid_IgG_pos"))  %>% select(-contains("covid_sero_pos")) )

var_single <- colSums(var_single, na.rm = TRUE)
var_single <- var_single/nrow(df_singlecases)*100

bar_df_prct <- data.frame(
  x = c("close contact reported", "PCR +", "stool +","PCR or stool or sero +", "any serology +", "sero + further NS", "IgA +", "IgM +", "IgG +", "close contact reported", "IgA +", "IgG +", "IgM +", "PCR +", "sero + further NS", "stool +"),
  vals = c(var_single, covid_cohort),
  col = c(rep("single", length(var_single)), rep("cohorts", length(covid_cohort)))
)

p_prct <- ggplot(bar_df_prct, aes(x = x, y =  vals, fill = col)) +
    geom_bar(stat = "identity", position = "dodge") +
    theme_bw() + 
    labs(title = "SARS-CoV2 testing", 
         subtitle = "Prct", x = "variable", y = "%", col = " ") +
    theme(axis.text.x=element_text(angle=90, hjust=1)) +
    scale_fill_manual(values = wes_palette("Royal1"))
#p_prct

neither_PCR_Ig <- nrow(df_singlecases %>% filter((covid_sero_any == FALSE | is.na(covid_sero_any)) & (covid_PCR_pos == FALSE | is.na(covid_PCR_pos)) & (covid_PCR_stool_pos == FALSE | is.na(covid_PCR_stool_pos))))

neither_PCR_Ig_closecontact <-
  nrow(df_singlecases %>% filter((covid_sero_any == FALSE |
                                    is.na(covid_sero_any)) &
                                   (covid_PCR_pos == FALSE |
                                      is.na(covid_PCR_pos)) &
                                   (covid_PCR_stool_pos == FALSE |
                                      is.na(covid_PCR_stool_pos)) &
                                   (covid_closecontact == FALSE | is.na(covid_closecontact))
  ))

print(paste0("Cases with neither PCR nor serology: ", neither_PCR_Ig))

print(paste0("Cases with neither PCR nor serology nor closecontact: ", neither_PCR_Ig_closecontact))
```

## Kawasaki criteria

```{r}
makeHeatmap_cohort("kawasaki", "kawasaki",exclude_single = "koyobas", plottitle = "Cases with kawasaki symptoms, per cohort")

barSymp("kawasaki", "kawasaki", exclude_single = "koyobas", plottitle = "Kawasaki symptoms")
```

## Shock
```{r}
makeBarplot("symp_cardiovasc_shock_n", "symp_cardiovasc_shock", "Shock")
```

## Lab values {.tabset}
For lab values, sometimes multiple values are reported (baseline, peak or not-specified). All lab values are collapsed based on the max (or the min for e.g. hemoglobin): so only the highest value of median, Q1 or Q3 is used. 

### C-reactive protein

```{r}
crp_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "CRP")
crp_collapse_single <- collapse_labvals_single(df_singlecases, "max", "CRP")
crp_missing <- sum(is.na(crp_collapse_single$CRP_max))

p_crp_cohort <- ggplot(crp_collapse_cohort, aes(y = cohort_id, x = CRP_med, col = cohort_type)) + 
        geom_point() +  
        geom_errorbar(aes(xmin=CRP_min, xmax=CRP_max), width=.2, position=position_dodge(.9)) + lims(x = c(0,600)) + 
        theme_bw() + labs(title = "CRP", y = "cohort", x = "") +
        geom_vline(xintercept = co_CRP, linetype = "dashed", color = "black") + theme(legend.justification = c(1, 1), legend.position = c(0.98, 0.98), legend.title=element_blank()) +
        scale_color_manual(values = wes_palette("Royal1"))

p_crp_single <- ggplot(crp_collapse_single, aes(x = as.numeric(CRP_max), y = cohort_id)) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill =  wes_palette("Darjeeling2")[1]) + 
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + lims(x = c(0,600)) + labs(y = "", x = "CRP (mg/dL)", subtitle = paste0("missing data for ", crp_missing, " cases")) +
      geom_hline(yintercept = co_CRP, linetype = "dashed", color = "black")

CRP_grid <- plot_grid(p_crp_cohort, p_crp_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
CRP_grid
```

### Lymphocytes
```{r}
lympho_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "min", "lympho")
lympho_collapse_single <- collapse_labvals_single(df_singlecases, "min", "lympho")
lympho_missing <- sum(is.na(lympho_collapse_single$lympho_min))

p_lympho_cohort <- ggplot(lympho_collapse_cohort, aes(y = cohort_id, x = lympho_med, col = cohort_type)) + 
        geom_point() +  
        geom_errorbar(aes(xmin=lympho_min, xmax=lympho_max), width=.2, position=position_dodge(.9)) + 
        theme_bw() + labs(title = "lymphocytes", y = "", x = "") + lims(x = c(0,7500))  +
         geom_vline(xintercept = co_lympho, linetype = "dashed", color = "black") + theme(legend.justification = c(1, 1), legend.position = c(0.98, 0.98), legend.title=element_blank()) +
        scale_color_manual(values = wes_palette("Royal1"))#+
        #rremove("y.text") 

p_lympho_single <- ggplot(lympho_collapse_single, aes(x = as.numeric(lympho_min), y = cohort_id)) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
      lims(x = c(0,7500))+
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5)  + labs(y = "", x = "Lymphocytes (/µL)", subtitle = paste0("missing data for ", lympho_missing, " cases")) +
      geom_vline(xintercept = co_lympho, linetype = "dashed", color = "black") #+ 
      #rremove("y.text") 

lympho_grid <- plot_grid(p_lympho_cohort, p_lympho_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
lympho_grid
```

### White blood cells
```{r}
wbc_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "WBC")
wbc_collapse_single <- collapse_labvals_single(df_singlecases, "max", "WBC")
wbc_missing <- sum(is.na(wbc_collapse_single$WBC_max))

p_wbc_cohort <- ggplot(wbc_collapse_cohort, aes(y = cohort_id, x = WBC_med, col = cohort_type)) + 
        geom_point() +  
        geom_errorbar(aes(xmin=WBC_min, xmax=WBC_max), width=.2, position=position_dodge(.9)) + lims(x = c(0,50000)) + 
        theme_bw() + labs(title = "WBC", y = "cohort", x = "")  +
        geom_vline(xintercept = co_WBC, linetype = "dashed", color = "black")  + theme(legend.justification = c(1, 1), legend.position = c(0.98, 0.98), legend.title=element_blank()) +
        scale_color_manual(values = wes_palette("Royal1"))

p_wbc_single <- ggplot(wbc_collapse_single, aes(x = as.numeric(WBC_max), y = cohort_id)) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "WBC (/µL)", subtitle = paste0("missing data for ", wbc_missing, " cases")) + lims(x = c(0,50000)) +
      geom_vline(xintercept = co_WBC, linetype = "dashed", color = "black") 

WBC_grid <- plot_grid(p_wbc_cohort, p_wbc_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
WBC_grid
```


### Ferritin
```{r}
ferritin_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "ferrit")
ferritin_collapse_single <- collapse_labvals_single(df_singlecases, "max", "ferrit")
ferritin_missing <- sum(is.na(ferritin_collapse_single$ferrit_max))

p_ferritin_cohort <- ggplot(ferritin_collapse_cohort, aes(y = cohort_id, x = ferrit_med, col = cohort_type)) + 
        geom_point() +  
        geom_errorbar(aes(xmin=ferrit_min, xmax=ferrit_max), width=.2, position=position_dodge(.9)) + lims(x = c(0,11000)) + 
        theme_bw() + labs(title = "Ferritin", y = "cohort", x = "") +
        geom_vline(xintercept = co_ferritin, linetype = "dashed", color = "black") + theme(legend.justification = c(1, 1), legend.position = c(0.98, 0.98), legend.title=element_blank()) +
        scale_color_manual(values = wes_palette("Royal1"))

p_ferritin_single <- ggplot(ferritin_collapse_single, aes(x = as.numeric(ferrit_max), y = cohort_id)) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "Ferritin (µg/l)", subtitle = paste0("missing data for ", ferritin_missing, " cases")) + lims(x = c(0,11000)) +
      geom_vline(xintercept = co_ferritin, linetype = "dashed", color = "black") 

ferritin_grid <- plot_grid(p_ferritin_cohort, p_ferritin_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
ferritin_grid
```


### Troponin
```{r}
troponin_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "troponin")
troponin_collapse_single <- collapse_labvals_single(df_singlecases, "max", "troponin")
troponin_missing <- sum(is.na(troponin_collapse_single$troponin_max))

p_troponin_cohort <- ggplot(troponin_collapse_cohort, aes(y = cohort_id, x = troponin_med, col = cohort_type)) + 
        geom_point() +  
        geom_errorbar(aes(xmin=troponin_min, xmax=troponin_max), width=.2, position=position_dodge(.9)) + lims(x = c(0,7000)) + 
        theme_bw() + labs(title = "Troponin", y = "cohort", x = "")  +
        geom_vline(xintercept = co_tropo, linetype = "dashed", color = "black")  + theme(legend.justification = c(1, 1), legend.position = c(0.98, 0.98), legend.title=element_blank()) +
        scale_color_manual(values = wes_palette("Royal1"))

p_troponin_single <- ggplot(troponin_collapse_single, aes(x = as.numeric(troponin_max), y = cohort_id)) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "Troponin (ng/L)", subtitle = paste0("missing data for ", troponin_missing, " cases")) + lims(x = c(0,7000)) +
      geom_vline(xintercept = co_tropo, linetype = "dashed", color = "black") 

troponin_grid <- plot_grid(p_troponin_cohort, p_troponin_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
troponin_grid
```


### IL-6
Note: The cases from Pouletty et al are added to the single cases as they report on IL6 values. 

```{r}
IL6_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "IL6")
IL6_collapse_single <- collapse_labvals_single(df_singlecases_inclPouletty, "max", "IL6")
IL6_missing <- sum(is.na(IL6_collapse_single$IL6_max))

p_IL6_cohort <- ggplot(IL6_collapse_cohort, aes(y = cohort_id, x = IL6_med)) + 
        geom_point() +  
        geom_errorbar(aes(xmin=IL6_min, xmax=IL6_max), width=.2, position=position_dodge(.9)) + lims(x = c(0,2500)) + 
        theme_bw() + labs(title = "IL6", y = "cohort", x = "")  +
        geom_vline(xintercept = co_IL6, linetype = "dashed", color = "black")  +
        scale_color_manual(values = wes_palette("Royal1"))

p_IL6_single <- ggplot(IL6_collapse_single, aes(x = as.numeric(IL6_max), y = cohort_id)) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "IL6 (pg/ml)", subtitle = paste0("missing data for ", IL6_missing, " cases")) + lims(x = c(0,2500)) +
      geom_vline(xintercept = co_IL6, linetype = "dashed", color = "black") 

IL6_grid <- plot_grid(p_IL6_cohort, p_IL6_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
IL6_grid
```


### BNP

```{r}
collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "_BNP")
collapse_single <- collapse_labvals_single(df_singlecases, "max", "_BNP")
missing <- sum(is.na(collapse_single$`_BNP_max`))

p_BNP_cohort <- ggplot(collapse_cohort, aes(y = cohort_id, x = `_BNP_med`, col = cohort_type)) + 
        geom_point() +  
        geom_errorbar(aes(xmin=`_BNP_min`, xmax=`_BNP_max`), width=.2, position=position_dodge(.9)) + lims(x = c(0,20000)) + 
        theme_bw() + labs(title = "BNP", y = "cohort", x = "")  +
        geom_vline(xintercept = co_BNP, linetype = "dashed", color = "black")  +theme(legend.justification = c(1, 1), legend.position = c(0.98, 0.98)) +
        scale_color_manual(values = wes_palette("Royal1"))

p_BNP_single <- ggplot(collapse_single, aes(x = as.numeric(`_BNP_max`), y = cohort_id)) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "BNP (pg/ml)", subtitle = paste0("missing data for ", missing, " cases")) + lims(x = c(0,20000)) +
      geom_vline(xintercept = co_BNP, linetype = "dashed", color = "black") 

BNP_grid <- plot_grid(p_BNP_cohort, p_BNP_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
BNP_grid
```

### NTproBNP
```{r}
collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "NTproBNP")
collapse_single <- collapse_labvals_single(df_singlecases, "max", "NTproBNP")
missing <- sum(is.na(collapse_single$NTproBNP_max))

p_NTproBNP_cohort <- ggplot(collapse_cohort, aes(y = cohort_id, x = NTproBNP_med, col = cohort_type)) + 
        geom_point() +  
        geom_errorbar(aes(xmin=NTproBNP_min, xmax=NTproBNP_max), width=.2, position=position_dodge(.9)) + lims(x = c(0,70000)) + 
        theme_bw() + labs(title = "NTproBNP", y = "cohort", x = "")  +
        geom_vline(xintercept = co_NTproBNP, linetype = "dashed", color = "black") + theme(legend.justification = c(1, 1), legend.position = c(0.98, 0.98), legend.title=element_blank()) +
        scale_color_manual(values = wes_palette("Royal1"))

p_NTproBNP_single <- ggplot(collapse_single, aes(x = as.numeric(NTproBNP_max), y = cohort_id)) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "NTproBNP (pg/ml)", subtitle = paste0("missing data for ", missing, " cases")) + lims(x = c(0,70000)) +
      geom_vline(xintercept = co_NTproBNP, linetype = "dashed", color = "black") 

NTproBNP_grid <- plot_grid(p_NTproBNP_cohort, p_NTproBNP_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
NTproBNP_grid
```


### Platelets

```{r}
collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "min", "platelet")
collapse_single <- collapse_labvals_single(df_singlecases, "min", "platelet")
missing <- sum(is.na(collapse_single$platelet_min))

p_platelet_cohort <- ggplot(collapse_cohort, aes(y = cohort_id, x = platelet_med, col = cohort_type)) + 
        geom_point() +  
        geom_errorbar(aes(xmin=platelet_min, xmax=platelet_max, col=cohort_type), width=.2, position=position_dodge(.9)) + lims(x = c(0,750000)) + 
        theme_bw() + labs(title = "platelet", y = "cohort", x = "")  +
        geom_vline(xintercept = co_platelet, linetype = "dashed", color = "black")  + theme(legend.justification = c(1, 1), legend.position = c(0.98, 0.98), legend.title=element_blank()) +
        scale_color_manual(values = wes_palette("Royal1"))

p_platelet_single <- ggplot(collapse_single, aes(x = as.numeric(platelet_min), y = cohort_id)) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "Platelets (/µL)", subtitle = paste0("missing data for ", missing, " cases")) + lims(x = c(0,750000)) +
      geom_vline(xintercept = co_platelet, linetype = "dashed", color = "black") 

platelet_grid <- plot_grid(p_platelet_cohort, p_platelet_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
platelet_grid
```


### D-dimers

```{r}
collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "Ddim")
collapse_single <- collapse_labvals_single(df_singlecases, "max", "Ddim")
missing <- sum(is.na(collapse_single$Ddim_max))

p_Ddim_cohort <- ggplot(collapse_cohort, aes(y = cohort_id, x = Ddim_med, col = cohort_type)) + 
        geom_point() +  
        geom_errorbar(aes(xmin=Ddim_min, xmax=Ddim_max, col=cohort_type), width=.2, position=position_dodge(.9)) + lims(x = c(0,11000)) + 
        theme_bw() + labs(title = "D-dimers", y = "cohort", x = "")  +
        geom_vline(xintercept = co_Ddim, linetype = "dashed", color = "black")  + theme(legend.justification = c(1, 1), legend.position = c(0.98, 0.98), legend.title=element_blank()) +
        scale_color_manual(values = wes_palette("Royal1"))

p_Ddim_single <- ggplot(collapse_single, aes(x = as.numeric(Ddim_max), y = cohort_id)) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "D-dimers (ng/ml)", subtitle = paste0("missing data for ", missing, " cases")) + lims(x = c(0,11000)) +
      geom_vline(xintercept = co_Ddim, linetype = "dashed", color = "black") 

Ddim_grid <- plot_grid(p_Ddim_cohort, p_Ddim_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
Ddim_grid
```


### Sodium

```{r}
collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "min", "sodium")
collapse_single <- collapse_labvals_single(df_singlecases, "min", "sodium")
missing <- sum(is.na(collapse_single$sodium_min))

p_sodium_cohort <- ggplot(collapse_cohort, aes(y = cohort_id, x = sodium_med, col = cohort_type)) + 
        geom_point() +  
        geom_errorbar(aes(xmin=sodium_min, xmax=sodium_max, col=cohort_type), width=.2, position=position_dodge(.9)) + lims(x = c(100,200)) + 
        theme_bw() + labs(title = "Sodium", y = "cohort", x = "")  +
        geom_vline(xintercept = co_sodium, linetype = "dashed", color = "black")  + theme(legend.justification = c(1, 1), legend.position = c(0.98, 0.98), legend.title=element_blank()) +
        scale_color_manual(values = wes_palette("Royal1"))

p_sodium_single <- ggplot(collapse_single, aes(x = as.numeric(sodium_min), y = cohort_id)) +
      geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
      geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
      theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "Sodium (mmol/L)", subtitle = paste0("missing data for ", missing, " cases")) + lims(x = c(100,200)) +
      geom_vline(xintercept = co_sodium, linetype = "dashed", color = "black") 

sodium_grid <- plot_grid(p_sodium_cohort, p_sodium_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
sodium_grid
```


## Critical care interventions

### Inotropes
```{r}
makeBarplot(var_id_cohort = "critcare_inotrop_n", var_id_single = "critcare_inotrop", var_id = "inotropes")
```

```{r}
makeHeatmap_cohort("critcare", "critcare",exclude_single = "days", plottitle = "Cases receiving critical care interventions, per cohort")

barSymp("critcare", "critcare", exclude_single = "days", plottitle = "Cases receiving critical care interventions")
```

## Treatments
### IVIg
```{r}
makeBarplot(var_id_cohort = "rx_IVIg_once_n", var_id_single = "rx_IVIg_once", var_id = "IVIg")
```

### Overall therapy
```{r}
makeHeatmap_cohort("rx", "rx",exclude_single = "days", plottitle = "Cases receiving treatment, per cohort")


barSymp("rx", "rx", exclude_single = "days", plottitle = "Cases receiving treatment")
```


# Case definitions
## Lab reference values
Cut-offs in this study:

- Neutrophilia > 8000/µL
- Elevated CRP > 10 mg/L
- Lymphopenia < 1250/µL
- WBC > 11000/µL
- Fibrinogen > 400 mg/dL
- D-dimers > 250 ng/mL
- Ferritin > 300 ng/mL
- Albumin < 34 g/L
- Procalcitonin > 0.49 ng/mL
- LDH > 280 U/L
- IL6 > 16.4 pg/mL
- ESR > 22 mm/
- BNP > 100 pg/mL
- NTproBNP > 400 pg/mL
- Troponin > 0.04 ng/mL

## PIMS-TS
[Source RCPCH](https://www.rcpch.ac.uk/sites/default/files/2020-05/COVID-19-Paediatric-multisystem-%20inflammatory%20syndrome-20200501.pdf)  

1. A child presenting with persistent fever, inflammation (neutrophilia, elevated CRP and lymphopaenia) and evidence of single or multi-organ dysfunction (shock, cardiac, respiratory, renal, gastrointestinal or neurological disorder) with additional features (see listed in Appendix 1 ). This may include children fulfilling full or partial criteria for Kawasaki disease.
2. Exclusion of any other microbial cause, including bacterial sepsis, staphylococcal or streptococcal shock syndromes, infections associated with myocarditis such as enterovirus (waiting for results of these investigations should not delay seeking expert advice).
3. SARS-CoV-2 PCR testing may be positive or negative 

We are unable to evaluate criteria 2.

```{r, fig.height= 10, fig.width= 8}
PIMS_TS_fulfilled <- apply(df_singlecases, 1, function(row) {
    # persistent fever, inflammation (neutrophilia, elevated CRP and lymphopaenia) 
    pat_id <- row["patientID_int"]
    fever <- row["symp_fever"] == TRUE
    neutrophilia <- as.numeric(row["lab_neutrophils"]) > co_neutrophilia
    elevated_CRP <- (as.numeric(row["lab_CRP_admis"]) > co_CRP | as.numeric(row["lab_CRP_NS"]) > co_CRP | as.numeric(row["lab_CRP_peak"]) > co_CRP )
    lymphopenia <- as.numeric(row["lab_lymphocytes_lowest"]) < co_lympho
    inflamm <- any(fever, neutrophilia, elevated_CRP, lymphopenia)
    
    # lab values
    #fibrinogen <- row["lab_fibrino"] > co_fibrino
    #Ddimers <- row["lab_Ddim_peak"] > co_Ddim |  row["lab_Ddim_NS"] > co_Ddim
    #ferritin <- (row["lab_ferritin_NS"] > co_ferritin | row["lab_ferritin_admis"] > co_ferritin | row["lab_ferritin_peak"] > co_ferritin)
    #albumin <- row["lab_albumin_admis"] < co_albu | row["lab_albumin_lowest"] < co_albu | row["lab_albumin_NS"] < co_albu
    #lab_vals <- any(fibrinogen, Ddimers, ferritin, albumin)
    
    # single or multi-organ dysfunction (shock, cardiac, respiratory, renal, gastrointestinal or neurological disorder)
    pneumonia <- row["symp_resp_pneumonia"] == TRUE
    resp_failure <- row["symp_resp_failure"] == TRUE
    resp <- any(pneumonia, resp_failure)
    
    AKI <- row["symp_renal_AKI"] == TRUE
    RRT <- row["critcare_RRT"] == TRUE
    renal <- any(AKI, RRT)
    
    myocarditis <- row["symp_cardiovasc_myocard"] == TRUE
    pericarditis <- row["symp_cardiovasc_pericard"] == TRUE
    LVEF_under30 <- row["symp_cardiovasc_LV_less30"] == TRUE
    LVEF_30to55 <- row["symp_cardiovasc_LV_30to55"] == TRUE
    BNP <- (as.numeric(row["lab_BNP_admis"]) > co_BNP | as.numeric(row["lab_BNP_max"]) > co_BNP ) 
    NTproBNP <- as.numeric(row["lab_NTproBNP"]) > co_NTproBNP
    tropo <- as.numeric(row["lab_troponin_admis"]) > co_tropo
    shock <- row["symp_cardiovasc_shock"] == TRUE
    
    cardiovasc <- any(myocarditis, LVEF_under30, LVEF_30to55, NTproBNP, BNP, tropo, shock)
    
    rash <- row["kawasaki_exanthema"] == TRUE
    dermato <- any(rash)
    
    organ_dysfunc <- sum(resp, renal, cardiovasc, dermato, na.rm = TRUE) >= 1

    criteria_fulfilled <- (inflamm) & organ_dysfunc #&lab_vals
    #return(c(pat_id, "criteria1_inflamm" = inflamm, "criteria2_labvals" = lab_vals, "criteria3_organdysfunc" = organ_dysfunc, "criteria_fulfilled" = criteria_fulfilled))
    return(c(pat_id, "criteria1_inflamm" = inflamm, "criteria3_organdysfunc" = organ_dysfunc, "criteria_fulfilled" = criteria_fulfilled))
})

PIMS_TS_fulfilled <- PIMS_TS_fulfilled %>% t() %>% as_tibble()
PIMS_TS_fulfilled <- type_convert(PIMS_TS_fulfilled)
PIMS_TS_fulfilled_heatmap <- PIMS_TS_fulfilled
cols <- sapply(PIMS_TS_fulfilled_heatmap, is.logical)
PIMS_TS_fulfilled_heatmap[,cols] <- lapply(PIMS_TS_fulfilled_heatmap[,cols], as.numeric)
PIMS_TS_fulfilled_heatmap_melt <- PIMS_TS_fulfilled_heatmap %>% melt()
PIMS_TS_fulfilled_heatmap_melt[is.na(PIMS_TS_fulfilled_heatmap_melt)] <- 2

skim(PIMS_TS_fulfilled)

#ggplot(PIMS_TS_fulfilled_heatmap_melt, aes(x = variable, y = as.character(patientID_int), fill = as.factor(value))) + geom_tile() + theme_classic() + theme(axis.line=element_blank()) + labs(y = "Patient ID", x = "criteria", fill = "criteria met", title = "Overview of which single cases fulfill PIMS-TS case definition") +  scale_fill_manual(labels = c("No", "Yes", "Missing"), values = c("pink2", "royalblue3", "darkgrey")) + theme(axis.text.x=element_text(angle=90, hjust=1))
```

## CDC MIS-C
[Source CDC](https://www.cdc.gov/mis-c/hcp/) and [UpToDate](https://www.uptodate.com/contents/image?imageKey=PEDS%2F128201&topicKey=PEDS%2F127488)
The case definition for MIS-C is:

1. Age <21 years
2. Clinical presentation consistent with MIS-C, including all of the following:
    - Fever
        - Documented fever >38.0°C (100.4°F) for ≥24 hours or
        - Report of subjective fever lasting ≥24 hours
    - Laboratory evidence of inflammation
    - Severe illness requiring hospitalization
    - Multisystem involvement
        - 2 or more organ systems involved
            - Cardiovascular (eg, shock, elevated troponin, elevated BNP, abnormal echocardiogram, arrhythmia)
            - Respiratory (eg, pneumonia, ARDS, pulmonary embolism)
            - Renal (eg, AKI, renal failure)
            - Neurologic (eg, seizure, stroke, aseptic meningitis)
            - Hematologic (eg, coagulopathy)
            - Gastrointestinal (eg, elevated liver enzymes, diarrhea, ileus, gastrointestinal bleeding)
            - Dermatologic (eg, erythroderma, mucositis, other rash)
3. No alternative plausible diagnoses
4. Recent or current SARS-CoV-2 infection or exposure
    - Any of the following:
    - Positive SARS-CoV-2 RT-PCR
    - Positive serology
    - Positive antigen test
    - COVID-19 exposure within the 4 weeks prior to the onset of symptoms



```{r, fig.height= 10, fig.width= 8}

CDC_fulfilled <- apply(df_singlecases, 1, function(row) {
    # criteria 1
    criteria1 = TRUE
    
    # criteria 2
    pat_id <- row["patientID_int"]
    
    # fever?
    fever <- row["symp_fever"] == TRUE | row["kawasaki_fever"] == TRUE

    inflamm <- any(fever)
    
    # lab values evidence for inflammation
    neutrophilia <- as.numeric(row["lab_neutrophils"]) > co_neutrophilia
    elevated_CRP <- (as.numeric(row["lab_CRP_admis"]) > co_CRP | as.numeric(row["lab_CRP_NS"]) > co_CRP | as.numeric(row["lab_CRP_peak"]) > co_CRP )
    lymphopenia <- as.numeric(row["lab_lymphocytes_lowest"]) < co_lympho
    fibrinogen <- as.numeric(row["lab_fibrino"]) > co_fibrino
    Ddimers <- as.numeric(row["lab_Ddim_peak"]) > co_Ddim |  as.numeric(row["lab_Ddim_NS"]) > co_Ddim
    ferritin <- (as.numeric(row["lab_ferritin_NS"]) > co_ferritin | as.numeric(row["lab_ferritin_admis"]) > co_ferritin | as.numeric(row["lab_ferritin_peak"]) > co_ferritin)
    albumin <- as.numeric(row["lab_albumin_admis"]) < co_albu | as.numeric(row["lab_albumin_lowest"]) < co_albu | as.numeric(row["lab_albumin_NS"]) < co_albu
    PCT <- as.numeric(row["lab_PCT_admis"]) > co_PCT | as.numeric(row["lab_PCT_peak"]) > co_PCT | as.numeric(row["lab_PCT_NS"]) > co_PCT 
    LDH <- as.numeric(row["lab_LDH"]) > co_LDH
    IL6 <- as.numeric(row["lab_IL6"]) > co_IL6
    ESR <- as.numeric(row["lab_ESR"]) > co_ESR

    lab_vals <- any(neutrophilia, elevated_CRP, lymphopenia, fibrinogen, Ddimers, ferritin, albumin, PCT, LDH, IL6, ESR)
    
    # Ilness requiring hospitalisation
    ## used surrogate parameters for hosp
    hosp_ICU <- row["admis_hosp_days"] > 1 | row["admis_ICU_days"] > 1 | row["admis_PICU_admis"] == TRUE
    NIV <- row["critcare_NIV"] == TRUE | row["critcare_NIV_days"] > 1
    MV <- row["critcare_MV"] == TRUE | row["critcare_MV_days"] > 1
    inotrop <- row["critcare_inotrop"] == TRUE | row["critcare_inotrop_days"] > 1
    ECMO <- row["critcare_ECMO"] == TRUE 
    IVIg <- row["rx_IVIg_once"] == TRUE  |  row["rx_IVIg_multip"] == TRUE 
    biologicals <- row["rx_anakinra"] == TRUE | row["rx_tocilizumab"] == TRUE | row["rx_infliximab"] == TRUE | row["rx_antibiotics"] == TRUE | row["rx_plasma"] == TRUE | row["rx_remdesivir"] == TRUE 
    heparin <- row["rx_heparin"] == TRUE


    req_hosp <- any(hosp_ICU, NIV, MV, inotrop, ECMO, IVIg, biologicals, heparin)
    
    ## multisystem involvement >= 2
    ## respiratory
    pneumonia <- row["symp_resp_pneumonia"] == TRUE
    resp_failure <- row["symp_resp_failure"] == TRUE
    resp <- any(pneumonia, resp_failure)
    
    AKI <- row["symp_renal_AKI"] == TRUE
    RRT <- row["critcare_RRT"] == TRUE
    renal <- any(AKI, RRT)
    
    myocarditis <- row["symp_cardiovasc_myocard"] == TRUE
    pericarditis <- row["symp_cardiovasc_pericard"] == TRUE
    LVEF_under30 <- row["symp_cardiovasc_LV_less30"] == TRUE
    LVEF_30to55 <- row["symp_cardiovasc_LV_30to55"] == TRUE
    BNP <- (as.numeric(row["lab_BNP_admis"]) > co_BNP | as.numeric(row["lab_BNP_max"]) > co_BNP ) 
    NTproBNP <- as.numeric(row["lab_NTproBNP"]) > co_NTproBNP
    tropo <- as.numeric(row["lab_troponin_admis"]) > co_tropo
    shock <- row["symp_cardiovasc_shock"] == TRUE
    
    cardiovasc <- any(myocarditis, LVEF_under30, LVEF_30to55, NTproBNP, BNP, tropo, shock)
    
    rash <- row["kawasaki_exanthema"] == TRUE
    dermato <- any(rash)
    
    organ_dysfunc <- sum(resp, renal, cardiovasc, dermato, na.rm = TRUE) >= 2
    
    criteria2 <- sum(inflamm, lab_vals, req_hosp, organ_dysfunc, na.rm = TRUE) == 4
    # criteria 3
    ## not evaluable
    criteria3 = TRUE
    # criteria 4
    # COVID pos?
    PCR_pos <- row["covid_PCR_pos"] == TRUE
    stool_pos <- row["covid_PCR_stool_pos"] == TRUE
    closecontact <- row["covid_closecontact"] == TRUE
    IgA <- row["covid_IgA_pos"] == TRUE
    IgM <- row["covid_IgM_pos"] == TRUE    
    IgG <- row["covid_IgG_pos"] == TRUE    
    any_sero <- row["covid_sero_pos"] == TRUE
    
    criteria4 <- any(PCR_pos, stool_pos, closecontact, IgA, IgM, IgG, any_sero)
    
    if (FALSE %in% c(criteria1, criteria2, criteria3, criteria4)){
      criteria_fulfilled <- FALSE
    } else if (NA %in% c(criteria1, criteria2, criteria3, criteria4)){
      criteria_fulfilled <- NA
    } else if (sum(criteria1, criteria2, criteria3, criteria4, na.rm = TRUE) == 4){
      criteria_fulfilled <- TRUE
    }
    
    #criteria_fulfilled <- sum(criteria1, criteria2, criteria3, criteria4, na.rm = TRUE) == 4
    return(c(pat_id, "criteria1_age" = criteria1, "criteria2_clinical" = criteria2, "criteria3_noAlt" = criteria3, "criteria4_recentExposure" = criteria4, "criteria_fulfilled" = criteria_fulfilled))
})

CDC_fulfilled <- CDC_fulfilled %>% t() %>% as_tibble()
CDC_fulfilled <- type_convert(CDC_fulfilled)
CDC_fulfilled_heatmap <- CDC_fulfilled
cols <- sapply(CDC_fulfilled_heatmap, is.logical)
CDC_fulfilled_heatmap[,cols] <- lapply(CDC_fulfilled_heatmap[,cols], as.numeric)
CDC_fulfilled_heatmap_melt <- CDC_fulfilled_heatmap %>% melt()
CDC_fulfilled_heatmap_melt[is.na(CDC_fulfilled_heatmap_melt)] <- 2

skim(CDC_fulfilled)
#ggplot(CDC_fulfilled_heatmap_melt, aes(x = variable, y = as.character(patientID_int), fill = as.factor(value))) + geom_tile() + theme_classic() + theme(axis.line=element_blank()) + labs(y = "Patient ID", x = "criteria", fill = "criteria met", title = "Overview of which single cases fulfill CDC MIS-C case definition") +  scale_fill_manual(labels = c("No", "Yes", "Missing"), values = c("pink2", "royalblue3", "darkgrey")) + theme(axis.text.x=element_text(angle=90, hjust=1))
```

## WHO case definition
[Source UpToDate](https://www.uptodate.com/contents/image?imageKey=PEDS%2F128201&topicKey=PEDS%2F127488):

All 6 criteria must be met:

1. Age 0 to 19 years
2. Fever for ≥3 days
3. Clinical signs of multisystem involvement (at least 2 of the following):
    - Rash, bilateral nonpurulent conjunctivitis, or mucocutaneous inflammation signs (oral, hands, or feet)
    - Hypotension or shock
    - Cardiac dysfunction, pericarditis, valvulitis, or coronary abnormalities (including echocardiographic findings or elevated troponin/BNP)
    - Evidence of coagulopathy (prolonged PT or PTT; elevated D-dimer)
    - Acute gastrointestinal symptoms (diarrhea, vomiting, or abdominal pain)
4. Elevated markers of inflammation (eg, ESR, CRP, or procalcitonin)
5. No other obvious microbial cause of inflammation, including bacterial sepsis and staphylococcal/streptococcal toxic shock syndromes
6. Evidence of SARS-CoV-2 infection
    - Any of the following:
    - Positive SARS-CoV-2 RT-PCR
    - Positive serology
    - Positive antigen test
    - Contact with an individual with COVID-19

```{r, fig.height= 10, fig.width= 8}
#row <- df_singlecases[87, ]
WHO_fulfilled <- apply(df_singlecases, 1, function(row) {
    pat_id <- row["patientID_int"]
    
    # criteria 1
    criteria1 = TRUE
    
    # criteria 2: fever?
    fever <- row["symp_fever"] == TRUE | row["kawasaki_fever"] == TRUE

    criteria2 <- any(fever)
    
    # criteria 3: clinical signs of multisystem involvement (at least 2)
    ## Rash, bilateral nonpurulent conjunctivitis, or mucocutaneous inflammation signs (oral, hands, or feet)
    rash <- row["kawasaki_exanthema"] == TRUE
    conjunctivitis <- row["kawasaki_conjunctivitis"] == TRUE
    mucocutaneaous <- row["kawasaki_mouth"] == TRUE | row["kawasaki_extremity"] == TRUE
    
    criteria3_a <- any(rash, conjunctivitis, mucocutaneaous)
    
    ## hypotension or shock
    shock <- row["symp_cardiovasc_shock"] == TRUE
    criteria3_b <- any(shock)
    
    ## cardiac dysfunction
    myocarditis <- row["symp_cardiovasc_myocard"] == TRUE
    pericarditis <- row["symp_cardiovasc_pericard"] == TRUE
    LVEF_under30 <- row["symp_cardiovasc_LV_less30"] == TRUE
    LVEF_30to55 <- row["symp_cardiovasc_LV_30to55"] == TRUE
    BNP <- (as.numeric(row["lab_BNP_admis"]) > co_BNP | as.numeric(row["lab_BNP_max"]) > co_BNP ) 
    NTproBNP <- as.numeric(row["lab_NTproBNP"]) > co_NTproBNP
    tropo <- as.numeric(row["lab_troponin_admis"]) > co_tropo
    coronary <- row["symp_cardiovasc_cordilat"] == TRUE | row["symp_cardiovasc_aneurysm"] == TRUE
    
    criteria3_c <- any(myocarditis, LVEF_under30, LVEF_30to55, NTproBNP, BNP, tropo, coronary)
    
    ## coagulopathy
    fibrinogen <- as.numeric(row["lab_fibrino"]) > co_fibrino
    Ddimers <- as.numeric(row["lab_Ddim_peak"]) > co_Ddim |  as.numeric(row["lab_Ddim_NS"]) > co_Ddim
    
    criteria3_d <- any(fibrinogen, Ddimers)
    
    ## acute GI symptoms
    GIsymp <- row["symp_GI_NS"] == TRUE | row["symp_GI_abdopain"] == TRUE | row["symp_GI_vomiting"] == TRUE | row["symp_GI_diarrh"] == TRUE | row["symp_GI_colitis"] == TRUE 
    
    criteria3_e <- any(GIsymp)
    
    criteria3 <- sum(criteria3_a, criteria3_b, criteria3_c, criteria3_d, criteria3_e, na.rm = TRUE) >= 2
      
    # criteria 4: Elevated markers of inflammation (eg, ESR, CRP, or procalcitonin)
    neutrophilia <- as.numeric(row["lab_neutrophils"]) > co_neutrophilia
    elevated_CRP <- (as.numeric(row["lab_CRP_admis"]) >= co_CRP) | (as.numeric(row["lab_CRP_NS"]) >= co_CRP) | (as.numeric(row["lab_CRP_peak"]) >= co_CRP )
  #  print(paste0(pat_id, elevated_CRP, row["lab_CRP_peak"]))
    lymphopenia <- as.numeric(row["lab_lymphocytes_lowest"]) < co_lympho

    ferritin <- (as.numeric(row["lab_ferritin_NS"]) > co_ferritin | as.numeric(row["lab_ferritin_admis"]) > co_ferritin | as.numeric(row["lab_ferritin_peak"]) > co_ferritin)
    albumin <- as.numeric(row["lab_albumin_admis"]) < co_albu | as.numeric(row["lab_albumin_lowest"]) < co_albu | as.numeric(row["lab_albumin_NS"]) < co_albu
    PCT <- as.numeric(row["lab_PCT_admis"]) > co_PCT | as.numeric(row["lab_PCT_peak"]) > co_PCT | as.numeric(row["lab_PCT_NS"]) > co_PCT 
    LDH <- as.numeric(row["lab_LDH"]) > co_LDH
    IL6 <- as.numeric(row["lab_IL6"]) > co_IL6
    ESR <- as.numeric(row["lab_ESR"]) > co_ESR

    criteria4 <- any(neutrophilia, elevated_CRP, lymphopenia, ferritin, albumin, PCT, LDH, IL6, ESR)

    # criteria 5: No other obvious microbial cause of inflammation
    criteria5 <- TRUE
    
    # criteria 6: COVID pos?
    PCR_pos <- row["covid_PCR_pos"] == TRUE
    stool_pos <- row["covid_PCR_stool_pos"] == TRUE
    closecontact <- row["covid_closecontact"] == TRUE
    IgA <- row["covid_IgA_pos"] == TRUE
    IgM <- row["covid_IgM_pos"] == TRUE    
    IgG <- row["covid_IgG_pos"] == TRUE    
    any_sero <- row["covid_sero_pos"] == TRUE
    
    criteria6 <- any(PCR_pos, stool_pos, closecontact, IgA, IgM, IgG, any_sero)
    
    if (NA %in% c(criteria1, criteria2, criteria3, criteria4, criteria5, criteria6)){
      criteria_fulfilled <- NA
    } else if (FALSE %in% c(criteria1, criteria2, criteria3, criteria4, criteria5, criteria6)){
      criteria_fulfilled <- FALSE
    } else if (sum(criteria1, criteria2, criteria3, criteria4, criteria5, criteria6, na.rm = TRUE) == 6){
      criteria_fulfilled <- TRUE
    } else {
      criteria_fulfilled <- FALSE
    }

    return(c(pat_id, "criteria1_age" = criteria1, "criteria2_fever" = criteria2, "criteria3_clinical" = criteria3, "criteria4_inflamm" = criteria4, "criteria5_noAlt" = criteria5, "criteria6_recentExposure" = criteria6, "criteria_fulfilled" = criteria_fulfilled))
})


WHO_fulfilled <- WHO_fulfilled %>% t() %>% as_tibble()
WHO_fulfilled <- type_convert(WHO_fulfilled)
WHO_fulfilled_heatmap <- WHO_fulfilled
cols <- sapply(WHO_fulfilled_heatmap, is.logical)
WHO_fulfilled_heatmap[,cols] <- lapply(WHO_fulfilled_heatmap[,cols], as.numeric)
WHO_fulfilled_heatmap_melt <- WHO_fulfilled_heatmap %>% melt()
WHO_fulfilled_heatmap_melt[is.na(WHO_fulfilled_heatmap_melt)] <- 2

skim(WHO_fulfilled)

#ggplot(WHO_fulfilled_heatmap_melt, aes(x = variable, y = as.character(patientID_int), fill = as.factor(value))) + geom_tile() + theme_classic() + theme(axis.line=element_blank()) + labs(y = "Patient ID", x = "criteria", fill = "criteria met", title = "Overview of which single cases fulfill WHO MIS-C case definition") +  scale_fill_manual(labels = c("No", "Yes", "Missing"), values = c("pink2", "royalblue3", "darkgrey")) + theme(axis.text.x=element_text(angle=90, hjust=1))
```

## Per-case overview
```{r, fig.height = 10, fig.width=7}
PIMS_TS_fulfilled_heatmap_melt$criteria <- "PIMS-TS"
WHO_fulfilled_heatmap_melt$criteria <- "WHO"
CDC_fulfilled_heatmap_melt$criteria <- "CDC"

full_heatmap <- rbind(PIMS_TS_fulfilled_heatmap_melt, WHO_fulfilled_heatmap_melt, CDC_fulfilled_heatmap_melt)

ggplot(full_heatmap, aes(x = variable, y = as.character(patientID_int), fill = as.factor(value))) + geom_tile() + theme_classic() + theme(axis.line=element_blank()) + labs(y = "Patient ID", x = "criteria", fill = "criteria met", title = "Overview of which single cases fulfill case definitions") +  scale_fill_manual(labels = c("No", "Yes", "Missing"), values = wes_palette("Zissou1")) + theme(axis.text.x=element_text(angle=90, hjust=1)) + facet_wrap(~ criteria, scales = "free_x")


```


## Summary
```{r}
criteria_summary <- data.frame(PIMS_TS_fulfilled %>% select(criteria_fulfilled), CDC_fulfilled %>% select(criteria_fulfilled), WHO_fulfilled %>% select(criteria_fulfilled))
colnames(criteria_summary) <- c("PIMS-TS", "CDC", "WHO")

cols <- sapply(criteria_summary, is.logical)
criteria_summary[,cols] <- lapply(criteria_summary[,cols], as.numeric)

criteria_summary <- criteria_summary %>% melt() %>% 
                          group_by(variable) %>% 
                          summarise(fulfilled = sum(value == 1, na.rm = TRUE), not_fulfilled = sum(value == 0, na.rm = TRUE), not_evaluable = sum(is.na(value)))
criteria_summary$sum <- rowSums(criteria_summary[,-1])

criteria_summary_melt <- criteria_summary %>% melt()
colnames(criteria_summary_melt) <- c("center", "fulfilled", "count")

fill_bar <- ggplot(criteria_summary_melt %>% filter(fulfilled != 'sum'), aes(x = center, y = count, fill = fulfilled)) + 
      geom_bar(stat = "identity", position = "fill") + theme_bw() + 
      labs(y = "ratio", title = "Single cases meeting which criteria", subtitle = paste0("percent of total (n = ", max(criteria_summary_melt$count) ,")")) +
        scale_fill_manual(values = wes_palette("Royal1")[c(1,2,4)])

dodge_bar <- ggplot(criteria_summary_melt %>% filter(fulfilled != 'sum'), aes(x = center, y = count, fill = fulfilled)) + 
      geom_bar(stat = "identity", position = "dodge") + theme_bw() + 
      labs(y = "n", title = "Single cases meeting which criteria", subtitle = "absolute values") +
        scale_fill_manual(values = wes_palette("Royal1")[c(1,2,4)])

ggarrange(dodge_bar, fill_bar, legend = "bottom", common.legend = TRUE)
```

# Association of case definition with outcome
```{r}
WHO_outcome <- WHO_fulfilled_heatmap %>% select(contains("patientID_int") | contains("criteria_fulfilled"))
colnames(WHO_outcome) <- c("patientID_int", "casedef_WHO_fulfilled")

CDC_outcome <- CDC_fulfilled_heatmap %>% select(contains("patientID_int") | contains("criteria_fulfilled"))
colnames(CDC_outcome) <- c("patientID_int", "casedef_CDC_fulfilled")

PIMS_TS_outcome <- PIMS_TS_fulfilled_heatmap %>% select(contains("patientID_int") | contains("criteria_fulfilled"))
colnames(PIMS_TS_outcome) <- c("patientID_int", "casedef_PIMS_TS_fulfilled")

assoc_outcome <- merge(WHO_outcome, CDC_outcome, by = "patientID_int")
assoc_outcome <- merge(assoc_outcome, PIMS_TS_outcome)
#assoc_outcome <- assoc_outcome[complete.cases(assoc_outcome[ ,-1]),]

outcome_params <- df_singlecases %>% select(patientID_int | symp_cardiovasc_cordilat | symp_cardiovasc_aneurysm | symp_cardiovasc_shock | outcome_death | critcare_MV | critcare_ECMO)

assoc_outcome_full <- merge(outcome_params, assoc_outcome, by = "patientID_int", all = TRUE)

cols <- sapply(assoc_outcome_full, is.logical)
assoc_outcome_full[,cols] <- lapply(assoc_outcome_full[,cols], as.numeric)

makeUpsetR(assoc_outcome_full %>% select(-contains("patientID")))
```

A new variable 'unfavourable course' made, which contains the following:

- symp_cardiovasc_cordilat 
- symp_cardiovasc_aneurysm
- symp_cardiovasc_shock 
- outcome_death
- critcare_MV 
- critcare_ECMO
- critcare_RRT
- critcare_inotrop
- admis_PICU_admis

Mild presentation means all of the above are either 0 or NA. 

```{r}
assoc_outcome <- merge(WHO_outcome, CDC_outcome, by = "patientID_int")
assoc_outcome <- merge(assoc_outcome, PIMS_TS_outcome)
#assoc_outcome <- #assoc_outcome[complete.cases(assoc_outcome[ ,-1]),]

outcome_params <- df_singlecases %>% select(patientID_int | contains("critcare")  | contains("admis_PICU_admis") | contains("outcome_death")  |contains ("symp_cardiovasc_cordilat") | contains ("symp_cardiovasc_aneurysm")  |contains("symp_cardiovasc_shock"))

assoc_outcome_full <- merge(outcome_params, assoc_outcome, by = "patientID_int")

cols <- sapply(assoc_outcome_full, is.logical)
assoc_outcome_full[,cols] <- lapply(assoc_outcome_full[,cols], as.numeric)

assoc_outcome_full$unfavourable_course <- ifelse(assoc_outcome_full$symp_cardiovasc_cordilat == 1 | assoc_outcome_full$symp_cardiovasc_aneurysm == 1 | assoc_outcome_full$symp_cardiovasc_shock == 1 | assoc_outcome_full$outcome_death == 1 | assoc_outcome_full$critcare_MV == 1 | assoc_outcome_full$critcare_ECMO == 1 | assoc_outcome_full$critcare_RRT == 1 | assoc_outcome_full$admis_PICU_admis == 1 | assoc_outcome_full$critcare_inotrop == 1 , 1, 0)

assoc_outcome_full$mild_presentation <- ifelse((assoc_outcome_full$unfavourable_course == 0 | is.na(assoc_outcome_full$unfavourable_course)), 1, 0)

makeUpsetR(assoc_outcome_full %>% select(contains("casedef") | contains("unfavourable_course") ))


makeUpsetR(assoc_outcome_full %>% select(contains("casedef") | contains("unfavourable_course")  | contains("mild_pres") ))

```

A new variable 'PICU candidate' made, which contains the following:

- symp_cardiovasc_shock 
- outcome_death
- critcare_MV 
- critcare_ECMO
- critcare_RRT
- critcare_inotrop
- admis_PICU_admis

Mild presentation means all of the above are either 0 or NA. 

```{r}
assoc_outcome <- merge(WHO_outcome, CDC_outcome, by = "patientID_int")
assoc_outcome <- merge(assoc_outcome, PIMS_TS_outcome)
#assoc_outcome <- assoc_outcome[complete.cases(assoc_outcome[ ,-1]),]

outcome_params <- df_singlecases %>% select(patientID_int | contains("critcare")  | contains("admis_PICU_admis") | contains("outcome_death")  |contains ("symp_cardiovasc_cordilat") | contains ("symp_cardiovasc_aneurysm")  |contains("symp_cardiovasc_shock"))

assoc_outcome_full <- merge(outcome_params, assoc_outcome, by = "patientID_int")

cols <- sapply(assoc_outcome_full, is.logical)
assoc_outcome_full[,cols] <- lapply(assoc_outcome_full[,cols], as.numeric)

assoc_outcome_full$PICU_candidate <- ifelse( assoc_outcome_full$symp_cardiovasc_shock == 1 | assoc_outcome_full$outcome_death == 1 | assoc_outcome_full$critcare_MV == 1 | assoc_outcome_full$critcare_ECMO == 1 | assoc_outcome_full$critcare_RRT == 1 | assoc_outcome_full$admis_PICU_admis == 1 | assoc_outcome_full$critcare_inotrop == 1 , 1, 0)

assoc_outcome_full$mild_presentation <- ifelse((assoc_outcome_full$PICU_candidate == 0 | is.na(assoc_outcome_full$PICU_candidate)), 1, 0)

makeUpsetR(assoc_outcome_full %>% select(contains("casedef") | contains("PICU_candidate") ))


makeUpsetR(assoc_outcome_full %>% select(contains("casedef") | contains("PICU_candidate")  | contains("mild_pres") ))

```


# Final figures

## Sex
```{r}
var_cohort <- df_cohort %>% select(contains("sex") | ("cohort_id") | "tot_cases_n")
var_cohort$cohort_id <- paste0(var_cohort$cohort_id, " (n = ", var_cohort$tot_cases_n,")")
sex_f <- var_cohort %>% group_by(cohort_id) %>% summarize(prct = sex_f/tot_cases_n) %>%  mutate(sex = "female")
sex_m <- var_cohort %>% group_by(cohort_id) %>% summarize(prct = sex_m/tot_cases_n) %>% mutate(sex = "male")
sex_all <- rbind(sex_f, sex_m)

p_sex_cohort <- ggplot(sex_all, aes(y = cohort_id, x = prct, fill = sex)) + 
  geom_bar(stat = "identity", position = "fill") + 
  theme_bw() + labs(x = "") +  labs(y = "") +
  scale_fill_manual(values = wes_palette("Royal1")) + theme(legend.position = "top", legend.title=element_blank())+
  rremove("y.text") 

var_controls <- df_cohort_controls %>% filter(cohort_type == "control") %>% select(contains("sex") | ("cohort_id") | "tot_cases_n")
var_controls$cohort_id <- paste0(var_controls$cohort_id, " (n = ", var_controls$tot_cases_n,")")
sex_f <- var_controls %>% group_by(cohort_id) %>% summarize(prct = sex_f/tot_cases_n) %>% mutate(sex = "female")
sex_m <- var_controls %>% group_by(cohort_id) %>% summarize(prct = sex_m/tot_cases_n) %>% mutate(sex = "male")
sex_all <- rbind(sex_f, sex_m)

p_sex_controls <- ggplot(sex_all, aes(y = cohort_id, x = prct, fill = sex)) + 
  geom_bar(stat = "identity", position = "fill") + 
  theme_bw() + labs(x = "") + 
  scale_fill_manual(values = wes_palette("Royal1"))+
  theme(legend.position = "none")  + labs(y = "")+
  rremove("y.text") 

n_single <- df_singlecases %>% nrow()
var_single <- df_singlecases %>% select(contains("sex"))
var_single$sex_m <- ifelse(var_single$sex == "M", TRUE, FALSE)
var_single$sex_f <- ifelse(var_single$sex == "F", TRUE, FALSE)
cols <- sapply(var_single, is.logical)
var_single[,cols] <- lapply(var_single[,cols], as.numeric)
var_single <- colSums(var_single %>% select(-sex), na.rm = TRUE)
var_single <- var_single/nrow(df_singlecases)*100

sex_single <- data.frame(cohort_id = paste0("single cases (n = ", n_single_cases, ")"), prct = c(var_single["sex_m"], var_single["sex_f"]), sex = c("male", "female"))

p_sex_single <- ggplot(sex_single, aes(y = cohort_id, x = prct, fill = sex)) + 
  geom_bar(stat = "identity", position = "fill") + 
  theme_bw() + 
  scale_fill_manual(values = wes_palette("Royal1"))+
  theme(legend.position = "none") + labs(y = "", x = "Fraction")+ rremove("y.text") 

plot_sex <- plot_grid(p_sex_cohort, p_sex_controls, p_sex_single, align = "v", nrow = 3, rel_heights = c(2/3, 1/5, 1/3))
plot_sex
```

## Age distribution

```{r}
cohort_age <- df_cohort_controls %>% select(contains("cohort_id") | contains("age") | contains("cohort_type")  | contains("tot_cases_n"))
cohort_age$cohort_id <- paste0(cohort_age$cohort_id, " (n = ", cohort_age$tot_cases_n,")")
cohort_age$age_med_yrs <- as.numeric(cohort_age$age_med_yrs )
cohort_age$age_Q1_yrs <- as.numeric(cohort_age$age_Q1_yrs)
cohort_age$age_Q3_yrs <- as.numeric(cohort_age$age_Q3_yrs)
cohort_age$age_min_yrs <- as.numeric(cohort_age$age_min_yrs)
cohort_age$age_max_yrs <- as.numeric(cohort_age$age_max_yrs)

cohort_age$data_descr <- ifelse(!is.na(cohort_age$age_Q1_yrs) & is.na(cohort_age$age_min_yrs) , "IQR", 
                                ifelse(is.na(cohort_age$age_Q1_yrs) & !is.na(cohort_age$age_min_yrs), "range", 
                                       ifelse(!is.na(cohort_age$age_Q1_yrs) & !is.na(cohort_age$age_min_yrs), "IQR + range", "none")))

p_age_cohort <- ggplot(cohort_age %>% filter(cohort_type == "covid"), aes(y = cohort_id, x = age_med_yrs, col = data_descr)) + 
  geom_point(size = 4) + 
  geom_errorbar(aes(xmin=age_Q1_yrs, xmax=age_Q3_yrs), width=.8, position=position_dodge(.9)) +
  geom_errorbar(aes(xmin=age_min_yrs,  xmax=age_max_yrs), width=.2, position=position_dodge(.9)) +
  theme_bw() + lims(x = c(0,21)) + 
  labs(y = "", x = "", col = "bars") + theme(legend.position="top", legend.title=element_blank())+
  scale_color_manual(values = c(wes_palette("BottleRocket2")[1:3], wes_palette("BottleRocket1")[2]))

p_age_controls <- ggplot(cohort_age %>% filter(cohort_type != "covid"), aes(y = cohort_id, x = age_med_yrs, col = data_descr)) + 
  geom_point(size = 4) + 
  geom_errorbar(aes(xmin=age_Q1_yrs, xmax=age_Q3_yrs), width=.2, position=position_dodge(.9)) +
  geom_errorbar(aes(xmin=age_min_yrs,  xmax=age_max_yrs), width=.2, position=position_dodge(.9)) +
  theme_bw() + lims(x = c(0,21)) +
  labs(y = "", x = "", col = "bars") + theme(legend.position="none")+
  scale_color_manual(values = wes_palette("BottleRocket2")[1])

p_age_single <- ggplot(df_singlecases, aes(x = as.numeric(age), y = paste0("single cases (n = ", n_single,")"))) +
  geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
  geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
  theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + lims(x = c(0,21)) + 
  labs(y = "", x = "Age (years)")

plot_age <- plot_grid(p_age_cohort, p_age_controls, p_age_single, align = "v", nrow = 3, rel_heights = c(2/3, 1/5, 1/3))
plot_age
```


```{r, fig.height= 10, fig.width=16}
figure <- ggarrange(plot_age, plot_sex, labels = c("A", "B"), widths = c(1.25,1))
ggsave(figure, filename = "./plots/demo_grid_plots.png", dpi = 300, height=7, width=10)
ggsave(figure, filename = "./plots/demo_grid_plots.svg", dpi = 300, height=7, width=10)
ggsave(figure, filename = "./plots/demo_grid_plots.pdf", dpi = 300, height=7, width=10)
figure
```


## Lab values
### C-reactive protein

```{r}
crp_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "CRP")
crp_collapse_single <- collapse_labvals_single(df_singlecases, "max", "CRP")
crp_missing <- sum(is.na(crp_collapse_single$CRP_max))

p_crp_cohort <- ggplot(crp_collapse_cohort, aes(y = cohort_id, x = CRP_med, col = cohort_type)) + 
  geom_point() +  
  geom_errorbar(aes(xmin=CRP_min, xmax=CRP_max), width=.2, position=position_dodge(.9)) + lims(x = c(0,600)) + 
  theme_bw() + labs(title = "CRP", y = "cohort", x = "") +
  geom_vline(xintercept = co_CRP, linetype = "dashed", color = "black") + theme(legend.justification = c(1, 1), legend.position = c(0.98, 0.98), legend.title=element_blank()) +
  scale_color_manual(values = wes_palette("Royal1"))

p_crp_single <- ggplot(crp_collapse_single, aes(x = as.numeric(CRP_max), y = cohort_id)) +
  geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
  geom_boxplot(width=.3, fill =  wes_palette("Darjeeling2")[1]) + 
  theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + lims(x = c(0,600)) + labs(y = "", x = "CRP (mg/dL)", subtitle = paste0("missing data for ", crp_missing, " cases")) +
  geom_hline(yintercept = co_CRP, linetype = "dashed", color = "black")

CRP_grid <- plot_grid(p_crp_cohort, p_crp_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
CRP_grid
```

### Ferritin
```{r}
ferritin_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "ferrit")
ferritin_collapse_single <- collapse_labvals_single(df_singlecases, "max", "ferrit")
ferritin_missing <- sum(is.na(ferritin_collapse_single$ferrit_max))

p_ferritin_cohort <- ggplot(ferritin_collapse_cohort, aes(y = cohort_id, x = ferrit_med, col = cohort_type)) + 
  geom_point() +  
  geom_errorbar(aes(xmin=ferrit_min, xmax=ferrit_max), width=.2, position=position_dodge(.9)) + lims(x = c(0,11000)) + 
  theme_bw() + labs(title = "Ferritin", y = "cohort", x = "") +
  geom_vline(xintercept = co_ferritin, linetype = "dashed", color = "black") + theme(legend.justification = c(1, 1), legend.position = "none", legend.title=element_blank()) +
  scale_color_manual(values = wes_palette("Royal1"))

p_ferritin_single <- ggplot(ferritin_collapse_single, aes(x = as.numeric(ferrit_max), y = cohort_id)) +
  geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
  geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
  theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "Ferritin (µg/l)", subtitle = paste0("missing data for ", ferritin_missing, " cases")) + lims(x = c(0,11000)) +
  geom_vline(xintercept = co_ferritin, linetype = "dashed", color = "black") 

ferritin_grid <- plot_grid(p_ferritin_cohort, p_ferritin_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
ferritin_grid
```


### IL-6
Note: The cases from Pouletty et al are added to the single cases as they report on IL6 values. 

```{r}
IL6_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "IL6")
IL6_collapse_single <- collapse_labvals_single(df_singlecases_inclPouletty, "max", "IL6")
IL6_missing <- sum(is.na(IL6_collapse_single$IL6_max))

p_IL6_cohort <- ggplot(IL6_collapse_cohort, aes(y = cohort_id, x = IL6_med, col = cohort_type)) + 
  geom_point() +  
  geom_errorbar(aes(xmin=IL6_min, xmax=IL6_max), width=.2, position=position_dodge(.9)) + lims(x = c(0,2500)) + 
  theme_bw() + labs(title = "IL6", y = "cohort", x = "")  +
  geom_vline(xintercept = co_IL6, linetype = "dashed", color = "black")  + theme(legend.justification = c(1, 1), legend.position = "none", legend.title=element_blank()) +
  scale_color_manual(values = wes_palette("Royal1"))

p_IL6_single <- ggplot(IL6_collapse_single, aes(x = as.numeric(IL6_max), y = cohort_id)) +
  geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
  geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
  theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "IL6 (pg/ml)", subtitle = paste0("missing data for ", IL6_missing, " cases")) + lims(x = c(0,2500))  +
  geom_vline(xintercept = co_IL6, linetype = "dashed", color = "black") 

IL6_grid <- plot_grid(p_IL6_cohort, p_IL6_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
IL6_grid
```


### White blood cells
```{r}
wbc_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "WBC")
wbc_collapse_single <- collapse_labvals_single(df_singlecases, "max", "WBC")
wbc_missing <- sum(is.na(wbc_collapse_single$WBC_max))

p_wbc_cohort <- ggplot(wbc_collapse_cohort, aes(y = cohort_id, x = WBC_med, col = cohort_type)) + 
  geom_point() +  
  geom_errorbar(aes(xmin=WBC_min, xmax=WBC_max), width=.2, position=position_dodge(.9)) + lims(x = c(0,50000)) + 
  theme_bw() + labs(title = "White blood cells", y = "", x = "")  +
  geom_vline(xintercept = co_WBC, linetype = "dashed", color = "black")  + theme(legend.justification = c(1, 1), legend.position = "none", legend.title=element_blank()) +
  scale_color_manual(values = wes_palette("Royal1"))+ rremove("y.text") 

p_wbc_single <- ggplot(wbc_collapse_single, aes(x = as.numeric(WBC_max), y = cohort_id)) +
  geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
  geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
  theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "WBC (/µL)", subtitle = paste0("missing data for ", wbc_missing, " cases")) + lims(x = c(0,50000)) +
  geom_vline(xintercept = co_WBC, linetype = "dashed", color = "black") + rremove("y.text") 

WBC_grid <- plot_grid(p_wbc_cohort, p_wbc_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
WBC_grid
```

### Lymphocytes
```{r}
lympho_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "min", "lympho")
lympho_collapse_single <- collapse_labvals_single(df_singlecases, "min", "lympho")
lympho_missing <- sum(is.na(lympho_collapse_single$lympho_min))

p_lympho_cohort <- ggplot(lympho_collapse_cohort, aes(y = cohort_id, x = lympho_med, col = cohort_type)) + 
  geom_point() +  
  geom_errorbar(aes(xmin=lympho_min, xmax=lympho_max), width=.2, position=position_dodge(.9)) + 
  theme_bw() + labs(title = "Lymphocytes", y = "", x = "") + lims(x = c(0,7500))  +
  geom_vline(xintercept = co_lympho, linetype = "dashed", color = "black") + theme(legend.justification = c(1, 1), legend.position = "none", legend.title=element_blank()) +
  scale_color_manual(values = wes_palette("Royal1"))+
  rremove("y.text") 

p_lympho_single <- ggplot(lympho_collapse_single, aes(x = as.numeric(lympho_min), y = cohort_id)) +
  geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
  geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
  lims(x = c(0,7500))+
  theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5)  + labs(y = "", x = "Lymphocytes (/µL)", subtitle = paste0("missing data for ", lympho_missing, " cases")) +
  geom_vline(xintercept = co_lympho, linetype = "dashed", color = "black") +  rremove("y.text") 

lympho_grid <- plot_grid(p_lympho_cohort, p_lympho_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
lympho_grid
```


### Troponin
```{r}
troponin_collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "troponin")
troponin_collapse_single <- collapse_labvals_single(df_singlecases, "max", "troponin")
troponin_missing <- sum(is.na(troponin_collapse_single$troponin_max))

p_troponin_cohort <- ggplot(troponin_collapse_cohort, aes(y = cohort_id, x = troponin_med, col = cohort_type)) + 
  geom_point() +  
  geom_errorbar(aes(xmin=troponin_min, xmax=troponin_max), width=.2, position=position_dodge(.9)) + lims(x = c(0,7000)) + 
  theme_bw() + labs(title = "Troponin", y = "", x = "")  +
  geom_vline(xintercept = co_tropo, linetype = "dashed", color = "black")  + theme(legend.justification = c(1, 1), legend.position = "none", legend.title=element_blank()) +
  scale_color_manual(values = wes_palette("Royal1"))+ rremove("y.text") 

p_troponin_single <- ggplot(troponin_collapse_single, aes(x = as.numeric(troponin_max), y = cohort_id)) +
  geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
  geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
  theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "Troponin (ng/L)", subtitle = paste0("missing data for ", troponin_missing, " cases")) + lims(x = c(0,7000)) +
  geom_vline(xintercept = co_tropo, linetype = "dashed", color = "black") + rremove("y.text") 

troponin_grid <- plot_grid(p_troponin_cohort, p_troponin_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
troponin_grid
```


### Platelets

```{r}
collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "min", "platelet")
collapse_single <- collapse_labvals_single(df_singlecases, "min", "platelet")
missing <- sum(is.na(collapse_single$platelet_min))

p_platelet_cohort <- ggplot(collapse_cohort, aes(y = cohort_id, x = platelet_med/1000, col = cohort_type)) + 
  geom_point() +  
  geom_errorbar(aes(xmin=platelet_min/1000, xmax=platelet_max/1000, col=cohort_type), width=.2, position=position_dodge(.9)) + lims(x = c(0,750)) + 
  theme_bw() + labs(title = "Platelets", y = "", x = "")  +
  geom_vline(xintercept = co_platelet/1000, linetype = "dashed", color = "black")  + theme(legend.justification = c(1, 1), legend.position = "none", legend.title=element_blank()) +
  scale_color_manual(values = wes_palette("Royal1"))+ rremove("y.text") 

p_platelet_single <- ggplot(collapse_single, aes(x = as.numeric(platelet_min)/1000, y = cohort_id)) +
  geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
  geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
  theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "Platelets (x1000/µL)", subtitle = paste0("missing data for ", missing, " cases")) + lims(x = c(0,750)) +
  geom_vline(xintercept = co_platelet, linetype = "dashed", color = "black") + rremove("y.text") 

platelet_grid <- plot_grid(p_platelet_cohort, p_platelet_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
platelet_grid
```


### D-dimers

```{r}
collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "max", "Ddim")
collapse_single <- collapse_labvals_single(df_singlecases, "max", "Ddim")
missing <- sum(is.na(collapse_single$Ddim_max))

p_Ddim_cohort <- ggplot(collapse_cohort, aes(y = cohort_id, x = Ddim_med, col = cohort_type)) + 
  geom_point() +  
  geom_errorbar(aes(xmin=Ddim_min, xmax=Ddim_max, col=cohort_type), width=.2, position=position_dodge(.9)) + lims(x = c(0,11000)) + 
  theme_bw() + labs(title = "D-dimers", y = "", x = "")  +
  geom_vline(xintercept = co_Ddim, linetype = "dashed", color = "black")  + theme(legend.justification = c(1, 1), legend.position = "none", legend.title=element_blank()) +
  scale_color_manual(values = wes_palette("Royal1")) + rremove("y.text") 

p_Ddim_single <- ggplot(collapse_single, aes(x = as.numeric(Ddim_max), y = cohort_id)) +
  geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
  geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
  theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", x = "D-dimers (ng/ml)", subtitle = paste0("missing data for ", missing, " cases")) + lims(x = c(0,11000)) +
  geom_vline(xintercept = co_Ddim, linetype = "dashed", color = "black") + rremove("y.text") 

Ddim_grid <- plot_grid(p_Ddim_cohort, p_Ddim_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
Ddim_grid
```


### Sodium

```{r}
collapse_cohort <- collapse_labvals_cohort(df_cohort_controls, "min", "sodium")
collapse_single <- collapse_labvals_single(df_singlecases, "min", "sodium")
missing <- sum(is.na(collapse_single$sodium_min))

p_sodium_cohort <- ggplot(collapse_cohort, aes(y = cohort_id, x = sodium_med, col = cohort_type)) + 
  geom_point() +  
  geom_errorbar(aes(xmin=sodium_min, xmax=sodium_max, col=cohort_type), width=.2, position=position_dodge(.9)) + lims(x = c(100,150)) + 
  theme_bw() + labs(title = "Sodium", y = "", x = "")  +
  geom_vline(xintercept = co_sodium, linetype = "dashed", color = "black")  + theme(legend.justification = c(1, 1), legend.position = "none", legend.title=element_blank()) +
  scale_color_manual(values = wes_palette("Royal1"))+ rremove("y.text") 

p_sodium_single <- ggplot(collapse_single, aes(x = as.numeric(sodium_min), y = cohort_id)) +
  geom_violin(fill = wes_palette("Darjeeling2")[4]) + 
  geom_boxplot(width=.3, fill = wes_palette("Darjeeling2")[1]) + 
  theme_bw() + geom_beeswarm(groupOnX=FALSE, alpha = 0.5) + labs(y = "", col = "", x = "Sodium (mmol/L)", subtitle = paste0("missing data for ", missing, " cases")) + lims(x = c(100,150)) +
  geom_vline(xintercept = co_sodium, linetype = "dashed", color = "black") + rremove("y.text") 

sodium_grid <- plot_grid(p_sodium_cohort, p_sodium_single, align = "v", nrow = 2, rel_heights = c(2/3, 1/3))
sodium_grid
```


### Grid plots
Example:
  
  Dashed lines equals reference value cut-off.

```{r, fig.height= 16, fig.width=12}
figure <- ggarrange(CRP_grid, WBC_grid, sodium_grid, ferritin_grid, lympho_grid, Ddim_grid, IL6_grid, platelet_grid, troponin_grid, labels = c("A", "B", "C", "D", "E", "G", "G", "H", "I"), widths = c(1.25,1,1))
ggsave(figure, filename = "./plots/lab_grid_plots.png", dpi = 300, height=16, width=12)
ggsave(figure, filename = "./plots/lab_grid_plots.svg", dpi = 300, height=12, width=16)
ggsave(figure, filename = "./plots/lab_grid_plots.pdf", dpi = 300, height=12, width=16)
figure
```

# SessionInfo
```{r}
sessionInfo()
```